<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>HanZen</title>

<!-- â”€â”€ PWA / iOS Home Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a1208">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="HanZen">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Serif+TC:wght@400;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Noto+Sans+SC&display=swap" rel="stylesheet">

<style>
  :root {
    --ink: #1a1208;
    --paper: #f5f0e8;
    --paper2: #ede7d8;
    --red: #c0392b;
    --gold: #b8860b;
    --gold-light: #d4a017;
    --green: #2d6a4f;
    --blue: #1a4a6b;
    --muted: #7a6a55;
    --border: #c8b89a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Cormorant Garamond', Georgia, serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse at 20% 50%, rgba(184,134,11,0.05) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 20%, rgba(192,57,43,0.04) 0%, transparent 50%),
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  /* HEADER */
  header {
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: calc(1.2rem + env(safe-area-inset-top)) calc(2.5rem + env(safe-area-inset-right)) 1.2rem calc(2.5rem + env(safe-area-inset-left));
    border-bottom: 1px solid var(--border);
    background: rgba(245,240,232,0.9);
    backdrop-filter: blur(8px);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    cursor: pointer;
    text-decoration: none;
  }
  .logo:hover .logo-text { color: var(--ink); }

  .logo-char {
    font-family: 'Noto Serif SC', serif;
    font-size: 2rem;
    color: var(--red);
    line-height: 1;
  }

  .logo-text {
    font-size: 1.1rem;
    font-weight: 300;
    letter-spacing: 0.15em;
    color: var(--muted);
    text-transform: uppercase;
    position: relative;
    top: -1px;
    transition: color 0.15s;
  }

  .header-stats {
    display: flex;
    gap: 2rem;
    font-size: 0.85rem;
    color: var(--muted);
  }

  .stat-item { text-align: center; }
  .stat-num {
    display: block;
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--ink);
    line-height: 1;
  }
  .stat-label {
    font-size: 0.7rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  /* LEVEL SELECTOR */
  .level-bar {
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.8rem 2.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--paper2);
    overflow-x: auto;
  }

  .level-label {
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    white-space: nowrap;
    margin-right: 0.5rem;
  }

  .level-btn {
    padding: 0.3rem 0.9rem;
    border: 1px solid var(--border);
    background: transparent;
    border-radius: 2px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.85rem;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.2s;
    white-space: nowrap;
  }

  .level-btn:hover { background: var(--paper); color: var(--ink); }

  .level-btn.active {
    background: var(--ink);
    color: var(--paper);
    border-color: var(--ink);
  }

  .level-btn.all-btn {
    border-color: var(--gold);
    color: var(--gold);
  }

  .level-btn.all-btn.active {
    background: var(--gold);
    color: var(--paper);
  }

  /* MAIN CONTENT */
  main {
    position: relative;
    z-index: 5;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2.5rem 1rem 4rem;
    min-height: calc(100vh - 120px);
  }

  /* QUEUE INFO */
  .queue-info {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
    font-size: 0.8rem;
    color: var(--muted);
    letter-spacing: 0.08em;
  }

  .queue-pill {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.3rem 0.8rem;
    border: 1px solid var(--border);
    border-radius: 20px;
    background: var(--paper2);
  }

  .queue-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
  }

  /* PROGRESS BAR */
  .progress-wrap {
    width: 100%;
    max-width: 600px;
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    margin-bottom: 2rem;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--red), var(--gold));
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  /* FLASHCARD */
  .card-scene {
    width: 100%;
    max-width: 600px;
    perspective: 1200px;
    margin-bottom: 1.5rem;
  }

  /* The card wrapper must be as tall as whichever face is taller.
     We achieve this by having both faces in normal flow when measuring,
     but only one visible at a time via the 3D flip.
     Trick: give the front a fixed min-height and let the back be auto;
     the scene gets its height from the front while flipped=false,
     then we set an explicit height once flipped via JS. */
  .card {
    position: relative;
    width: 100%;
    transform-style: preserve-3d;
    transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }

  .card.flipped {
    transform: rotateY(180deg);
  }

  .card-face {
    width: 100%;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: #faf6ee;
    box-shadow:
      0 2px 4px rgba(0,0,0,0.06),
      0 8px 24px rgba(0,0,0,0.08),
      inset 0 1px 0 rgba(255,255,255,0.8);
    overflow: hidden;
  }

  /* The back face is positioned absolute so it sits exactly over the front.
     We also add a JS-driven min-height on .card so the scene is tall enough. */
  .card-face.card-back {
    position: absolute;
    top: 0; left: 0; right: 0;
    transform: rotateY(180deg);
  }

  /* CARD FRONT */
  .card-front-inner {
    padding: 3.5rem 3rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    min-height: 260px;
    justify-content: center;
  }

  .hsk-badge {
    position: absolute;
    top: 1rem; right: 1rem;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
  }

  .card-number {
    position: absolute;
    top: 1rem; left: 1rem;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  .char-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }

  .simplified {
    font-family: 'Noto Serif SC', serif;
    font-size: 4.5rem;
    line-height: 1;
    color: var(--ink);
    letter-spacing: 0.05em;
  }

  .traditional {
    font-family: 'Noto Serif TC', serif;
    font-size: 1.2rem;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  .trad-label {
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--border);
  }

  .tap-hint {
    font-size: 0.75rem;
    color: var(--border);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-top: 1rem;
  }

  /* CARD BACK */
  .card-back-inner {
    padding: 2rem 2.5rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
  }

  .back-header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    padding-bottom: 1rem;
  }

  .back-chars {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  .back-simplified {
    font-family: 'Noto Serif SC', serif;
    font-size: 2.8rem;
    line-height: 1;
    color: var(--ink);
    letter-spacing: 0.05em;
  }

  .back-traditional {
    font-family: 'Noto Serif TC', serif;
    font-size: 0.95rem;
    color: var(--muted);
  }

  .pinyin-display {
    font-size: 1.4rem;
    font-weight: 300;
    color: var(--red);
    letter-spacing: 0.05em;
    font-style: italic;
  }

  .meaning-display {
    font-size: 1.1rem;
    color: var(--ink);
    font-weight: 300;
    line-height: 1.4;
  }

  /* AUDIO BUTTONS */
  .audio-row {
    display: flex;
    gap: 0.8rem;
    align-items: center;
  }

  .audio-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.9rem;
    border: 1px solid var(--border);
    background: var(--paper2);
    border-radius: 2px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.8rem;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }

  .audio-btn:hover { background: var(--paper); color: var(--ink); border-color: var(--ink); }

  .audio-btn.playing {
    border-color: var(--red);
    color: var(--red);
    background: rgba(192,57,43,0.05);
  }

  .speaker-icon { font-size: 1rem; }

  /* SECTION DIVIDER */
  .section-divider {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin: 0.2rem 0;
  }

  .section-divider::before,
  .section-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
    opacity: 0.5;
  }

  .section-label {
    font-size: 0.62rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--muted);
  }

  /* EXAMPLE SENTENCE */
  .example-block {
    background: var(--paper2);
    border-left: 2px solid var(--gold);
    padding: 0.8rem 1rem;
    border-radius: 0 2px 2px 0;
  }

  .example-zh {
    font-family: 'Noto Serif SC', serif;
    font-size: 1.05rem;
    color: var(--ink);
    margin-bottom: 0.3rem;
    line-height: 1.6;
  }

  .example-zh .highlight-word {
    color: var(--red);
    border-bottom: 1px solid var(--red);
  }

  .example-pinyin {
    font-size: 0.85rem;
    color: var(--red);
    font-style: italic;
    margin-bottom: 0.3rem;
  }

  .example-en {
    font-size: 0.85rem;
    color: var(--muted);
    font-style: italic;
  }

  /* CHAR BREAKDOWN */
  .char-breakdown {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .char-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem;
    padding: 0.6rem 0.8rem;
    border: 1px solid var(--border);
    border-radius: 2px;
    background: var(--paper);
    min-width: 70px;
  }

  .char-card-zh {
    font-family: 'Noto Serif SC', serif;
    font-size: 1.6rem;
    color: var(--ink);
    line-height: 1;
  }

  .char-card-tc {
    font-family: 'Noto Serif TC', serif;
    font-size: 0.7rem;
    color: var(--muted);
  }

  .char-card-meaning {
    font-size: 0.7rem;
    color: var(--muted);
    text-align: center;
    line-height: 1.3;
    max-width: 80px;
  }

  /* RATING BUTTONS â€” rendered inside the card back face */
  .rating-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.7rem;
    width: 100%;
    padding: 1rem 1.5rem 1.5rem;
    border-top: 1px solid var(--border);
    background: var(--paper2);
    /* Never hidden â€” shown as part of card back content */
  }

  .rating-label {
    font-size: 0.68rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .rating-btns {
    display: flex;
    gap: 0.7rem;
    width: 100%;
  }

  .rating-btn {
    flex: 1;
    padding: 0.85rem 0.5rem;
    border: 2px solid;
    border-radius: 3px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.18s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    background: #faf6ee;
    letter-spacing: 0.02em;
  }

  .rating-btn .sub {
    font-size: 0.62rem;
    letter-spacing: 0.08em;
    font-weight: 400;
    opacity: 0.75;
  }

  .rating-btn.forgot {
    border-color: #c0392b;
    color: #c0392b;
  }
  .rating-btn.forgot:hover, .rating-btn.forgot:active {
    background: #c0392b;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(192,57,43,0.3);
  }

  .rating-btn.remembered {
    border-color: var(--blue);
    color: var(--blue);
  }
  .rating-btn.remembered:hover, .rating-btn.remembered:active {
    background: var(--blue);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(26,74,107,0.3);
  }

  .rating-btn.hard {
    border-color: #d35400;
    color: #d35400;
  }
  .rating-btn.hard:hover, .rating-btn.hard:active {
    background: #d35400;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(211,84,0,0.3);
  }

  .rating-btn.easy {
    border-color: var(--green);
    color: var(--green);
  }
  .rating-btn.easy:hover, .rating-btn.easy:active {
    background: var(--green);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(45,106,79,0.3);
  }

  /* SETTINGS PANEL */
  .settings-overlay {
    position: fixed;
    inset: 0;
    background: rgba(26,18,8,0.45);
    z-index: 200;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .settings-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .settings-panel {
    position: fixed;
    top: 0; right: 0; bottom: 0;
    width: min(380px, 92vw);
    background: #faf6ee;
    border-left: 1px solid var(--border);
    z-index: 201;
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    box-shadow: -8px 0 32px rgba(0,0,0,0.12);
    overflow-y: auto;
  }
  .settings-panel.open {
    transform: translateX(0);
  }

  .settings-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.4rem 1.6rem 1rem;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .settings-title {
    font-size: 1.15rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    color: var(--ink);
  }

  .settings-close {
    width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
    border: 1px solid var(--border);
    border-radius: 2px;
    background: transparent;
    cursor: pointer;
    font-size: 1.1rem;
    color: var(--muted);
    transition: all 0.15s;
  }
  .settings-close:hover { background: var(--ink); color: var(--paper); border-color: var(--ink); }

  .settings-body {
    padding: 1.6rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
    flex: 1;
  }

  .settings-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .settings-group-title {
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.5rem;
  }

  .setting-row {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .setting-label-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .setting-label {
    font-size: 0.9rem;
    color: var(--ink);
    font-weight: 400;
  }

  .setting-desc {
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.4;
    font-style: italic;
  }

  .setting-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--red);
    min-width: 36px;
    text-align: right;
  }

  .setting-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 4px;
    border-radius: 2px;
    background: var(--border);
    outline: none;
    cursor: pointer;
  }
  .setting-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--ink);
    cursor: pointer;
    border: 2px solid var(--paper);
    box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    transition: background 0.15s;
  }
  .setting-slider::-webkit-slider-thumb:hover { background: var(--red); }
  .setting-slider::-moz-range-thumb {
    width: 18px; height: 18px;
    border-radius: 50%;
    background: var(--ink);
    cursor: pointer;
    border: 2px solid var(--paper);
    box-shadow: 0 1px 4px rgba(0,0,0,0.25);
  }

  .settings-save-btn {
    margin: 0 1.6rem 1.6rem;
    padding: 0.9rem;
    background: var(--ink);
    color: var(--paper);
    border: none;
    border-radius: 3px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.18s;
    flex-shrink: 0;
  }
  .settings-save-btn:hover { background: var(--red); }

  /* SETTINGS TRIGGER BUTTON in header */
  .settings-trigger {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.8rem;
    border: 1px solid var(--border);
    border-radius: 2px;
    background: transparent;
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.82rem;
    letter-spacing: 0.08em;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .settings-trigger:hover { background: var(--ink); color: var(--paper); border-color: var(--ink); }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    max-width: 500px;
  }

  .empty-char {
    font-family: 'Noto Serif SC', serif;
    font-size: 5rem;
    color: var(--border);
    margin-bottom: 1rem;
  }

  .empty-title {
    font-size: 1.8rem;
    font-weight: 300;
    margin-bottom: 0.5rem;
  }

  .empty-sub {
    font-size: 0.9rem;
    color: var(--muted);
    line-height: 1.6;
  }

  /* INTRO SCREEN */
  #intro-screen {
    position: fixed;
    inset: 0;
    background: var(--paper);
    z-index: 100;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: 1.5rem;
    padding: 2.5rem 2rem 3rem;
    text-align: center;
    overflow-y: auto;
  }

  .intro-logo {
    font-family: 'Noto Serif SC', serif;
    font-size: 6rem;
    color: var(--red);
    line-height: 1;
    animation: fadeInUp 0.8s ease both;
  }

  .intro-title {
    font-size: 2.5rem;
    font-weight: 300;
    letter-spacing: 0.1em;
    animation: fadeInUp 0.8s 0.1s ease both;
  }

  .intro-sub {
    font-size: 1rem;
    color: var(--muted);
    max-width: 420px;
    line-height: 1.7;
    animation: fadeInUp 0.8s 0.2s ease both;
  }

  .intro-features {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    max-width: 480px;
    animation: fadeInUp 0.8s 0.3s ease both;
  }

  .intro-feature {
    text-align: left;
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: 2px;
    background: var(--paper2);
  }

  .feature-icon { font-size: 1.3rem; margin-bottom: 0.3rem; }
  .feature-name {
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    margin-bottom: 0.2rem;
  }
  .feature-desc { font-size: 0.75rem; color: var(--muted); line-height: 1.4; }

  .start-btn {
    padding: 1rem 3rem;
    background: var(--ink);
    color: var(--paper);
    border: none;
    border-radius: 2px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.1rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    animation: fadeInUp 0.8s 0.4s ease both;
  }

  .start-btn:hover {
    background: var(--red);
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(192,57,43,0.3);
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* AUDIO WAVE ANIMATION */
  .wave-anim {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    height: 14px;
  }

  .wave-bar {
    width: 3px;
    border-radius: 2px;
    background: currentColor;
    animation: wave 0.8s ease-in-out infinite;
  }

  .wave-bar:nth-child(2) { animation-delay: 0.15s; }
  .wave-bar:nth-child(3) { animation-delay: 0.3s; }
  .wave-bar:nth-child(4) { animation-delay: 0.45s; }

  @keyframes wave {
    0%, 100% { height: 4px; }
    50% { height: 12px; }
  }

  /* CARD SLIDE ANIMATION */
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(30px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .card-scene { animation: slideIn 0.4s ease both; }

  /* COMPLETION ANIMATION */
  @keyframes celebrate {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .celebrate { animation: celebrate 0.4s ease; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--paper2); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* NOTIFICATION */
  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--ink);
    color: var(--paper);
    padding: 0.7rem 1.5rem;
    border-radius: 2px;
    font-size: 0.85rem;
    letter-spacing: 0.05em;
    opacity: 0;
    transition: all 0.3s;
    z-index: 999;
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* ========================
     ANALYTICS PANEL
  ======================== */
  .analytics-overlay {
    position: fixed; inset: 0;
    background: rgba(26,18,8,0.5);
    z-index: 500; opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
    backdrop-filter: blur(2px);
  }
  .analytics-overlay.open { opacity: 1; pointer-events: all; }
  .analytics-panel {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -46%) scale(0.97);
    width: min(580px, 95vw);
    max-height: 85vh;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 2px;
    box-shadow: 0 16px 64px rgba(26,18,8,0.22);
    z-index: 600;
    display: flex; flex-direction: column;
    opacity: 0; pointer-events: none;
    transition: all 0.28s cubic-bezier(0.34,1.2,0.64,1);
  }
  .analytics-panel.open {
    opacity: 1; pointer-events: all;
    transform: translate(-50%, -50%) scale(1);
  }
  .analytics-header {
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 1.1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .analytics-title {
    font-size: 0.9rem; font-weight: 600;
    letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--gold);
  }
  .analytics-close {
    background: none; border: none;
    font-size: 1.1rem; color: var(--muted);
    cursor: pointer; padding: 0.2rem 0.5rem; line-height: 1;
  }
  .analytics-close:hover { color: var(--ink); }
  .analytics-body {
    overflow-y: auto; padding: 1.4rem 1.5rem; flex: 1;
  }
  .an-summary {
    display: flex; gap: 0;
    border: 1px solid var(--border); border-radius: 2px;
    margin-bottom: 1.6rem; overflow: hidden;
  }
  .an-summary-item {
    flex: 1; text-align: center;
    padding: 0.75rem 0.5rem;
    border-right: 1px solid var(--border);
  }
  .an-summary-item:last-child { border-right: none; }
  .an-summary-num {
    display: block; font-size: 1.5rem; font-weight: 600;
    color: var(--ink); line-height: 1.1;
  }
  .an-summary-label {
    font-size: 0.62rem; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--muted);
    display: block; margin-top: 0.2rem;
  }
  .an-section { margin-bottom: 1.8rem; }
  .an-section:last-child { margin-bottom: 0; }
  .an-section-title {
    font-size: 0.63rem; letter-spacing: 0.18em;
    text-transform: uppercase; color: var(--muted);
    margin-bottom: 1rem; padding-bottom: 0.4rem;
    border-bottom: 1px solid var(--border);
  }
  .an-sub-label {
    font-size: 0.76rem; font-style: italic;
    color: var(--muted); margin-bottom: 0.55rem;
  }
  .snap-bar {
    display: flex; height: 22px;
    border-radius: 2px; overflow: hidden;
    background: var(--paper2); border: 1px solid var(--border);
    margin-bottom: 0.55rem;
  }
  .snap-seg { transition: width 0.4s ease; min-width: 0; }
  .snap-seg.s0 { background: var(--red); }
  .snap-seg.s2 { background: #d35400; }
  .snap-seg.s3 { background: var(--blue); }
  .snap-seg.s5 { background: var(--green); }
  .an-legend {
    display: flex; gap: 1rem; flex-wrap: wrap;
    margin-bottom: 1.2rem;
  }
  .an-legend-item {
    display: flex; align-items: center;
    gap: 0.3rem; font-size: 0.76rem; color: var(--ink);
  }
  .an-legend-dot {
    width: 9px; height: 9px;
    border-radius: 50%; flex-shrink: 0;
  }
  .an-legend-dot.s0 { background: var(--red); }
  .an-legend-dot.s2 { background: #d35400; }
  .an-legend-dot.s3 { background: var(--blue); }
  .an-legend-dot.s5 { background: var(--green); }
  .rbar-row { display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.55rem; }
  .rbar-label { font-size: 0.76rem; width: 62px; flex-shrink: 0; }
  .rbar-track { flex: 1; height: 13px; background: var(--paper2); border-radius: 2px; overflow: hidden; }
  .rbar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
  .rbar-fill.s0 { background: var(--red); }
  .rbar-fill.s2 { background: #d35400; }
  .rbar-fill.s3 { background: var(--blue); }
  .rbar-fill.s5 { background: var(--green); }
  .rbar-count { font-size: 0.76rem; width: 34px; text-align: right; color: var(--muted); flex-shrink: 0; }
  .act-tabs {
    display: flex; border: 1px solid var(--border);
    border-radius: 2px; overflow: hidden;
    margin-bottom: 1rem; width: fit-content;
  }
  .act-tab {
    background: none; border: none;
    padding: 0.38rem 0.85rem;
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 0.76rem; letter-spacing: 0.05em;
    color: var(--muted); cursor: pointer;
    border-right: 1px solid var(--border);
    transition: all 0.15s;
  }
  .act-tab:last-child { border-right: none; }
  .act-tab.active { background: var(--ink); color: var(--paper); }
  .act-row { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.5rem; }
  .act-row-label { font-size: 0.72rem; width: 52px; flex-shrink: 0; color: var(--muted); text-align: right; }
  .act-row-track { flex: 1; height: 16px; background: var(--paper2); border-radius: 2px; overflow: hidden; display: flex; }
  .act-bar-rev { height: 100%; background: var(--blue); opacity: 0.75; }
  .act-bar-new { height: 100%; background: var(--red); opacity: 0.85; }
  .act-row-count { font-size: 0.72rem; min-width: 90px; color: var(--muted); }
  .act-empty { font-size: 0.85rem; color: var(--muted); font-style: italic; padding: 0.8rem 0; }
  .act-legend { display: flex; gap: 1rem; margin-top: 0.8rem; }
  .analytics-btn {
    background: none; border: 1px solid var(--gold);
    color: var(--gold);
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 0.82rem; letter-spacing: 0.08em;
    padding: 0.35rem 0.9rem; cursor: pointer;
    border-radius: 2px; transition: all 0.2s; white-space: nowrap;
  }
  .analytics-btn:hover { background: var(--gold); color: var(--paper); }

  /* ========================
     DECK SELECTOR
  ======================== */
  .deck-select-section {
    animation: fadeInUp 0.8s 0.3s ease both;
    width: 100%;
    max-width: 500px;
  }
  .deck-select-label {
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.8rem;
  }
  .deck-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 0.8rem;
    width: 100%;
    box-sizing: border-box;
  }
  #deck-card-hsk, #deck-card-sentences,
  #modal-deck-hsk, #modal-deck-sentences {
    grid-column: 1 / -1 !important;
  }
  .deck-card-sub { font-size: 0.7rem; color: var(--muted); margin-bottom: 0.25rem; letter-spacing: 0.04em; text-transform: uppercase; }
  .deck-card {
    border: 2px solid var(--border);
    border-radius: 2px;
    padding: 0.9rem 0.8rem;
    background: var(--paper2);
    cursor: pointer;
    text-align: left;
    transition: all 0.2s;
    font-family: 'Cormorant Garamond', serif;
    position: relative;
  }
  .deck-card:hover { border-color: var(--ink); background: var(--paper); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .deck-card.selected { border-color: var(--red); background: var(--paper); }
  .deck-card-icon { font-size: 1.8rem; margin-bottom: 0.5rem; display: block; }
  .deck-card-name { font-size: 1rem; font-weight: 600; margin-bottom: 0.2rem; }
  .deck-card-desc { font-size: 0.72rem; color: var(--muted); line-height: 1.4; }
  .deck-card-count { font-size: 0.68rem; color: var(--muted); margin-top: 0.5rem; font-style: italic; }
  .deck-card.selected .deck-card-name { color: var(--red); }

  .change-deck-btn {
    background: none; border: 1px solid var(--muted);
    color: var(--muted);
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 0.82rem; letter-spacing: 0.08em;
    padding: 0.35rem 0.9rem; cursor: pointer;
    border-radius: 2px; transition: all 0.2s; white-space: nowrap;
  }
  .change-deck-btn:hover { border-color: var(--ink); color: var(--ink); }

  /* Sentence card specific styles */
  .sentence-front-phrase {
    font-family: 'Noto Serif SC', serif;
    font-size: 2.4rem;
    color: var(--ink);
    line-height: 1.3;
    margin-bottom: 0.5rem;
  }
  .sentence-front-trad {
    font-family: 'Noto Serif SC', serif;
    font-size: 1.1rem;
    color: var(--ink-light);
    margin-top: 0.3rem;
  }
  .sentence-front-pinyin {
    font-size: 1rem;
    color: var(--red);
    letter-spacing: 0.05em;
  }
  .sentence-badge {
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 0.15rem 0.5rem;
    display: inline-block;
    margin-bottom: 1rem;
  }
  .sentence-meaning {
    font-size: 1.1rem;
    color: var(--blue);
    font-style: italic;
    margin-bottom: 0.3rem;
  }

  /* Deck selector overlay (for change-deck mid-session) */
  .deck-overlay {
    position: fixed; inset: 0;
    background: rgba(26,18,8,0.6);
    z-index: 200;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
    display: flex; align-items: center; justify-content: center;
  }
  .deck-overlay.open { opacity: 1; pointer-events: all; }
  .deck-modal {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    text-align: center;
  }
  .deck-modal-title { font-size: 1.3rem; font-weight: 300; letter-spacing: 0.08em; margin-bottom: 0.5rem; }
  .deck-modal-sub { font-size: 0.85rem; color: var(--muted); margin-bottom: 1.5rem; }
  .deck-modal-close {
    margin-top: 1rem;
    background: none; border: 1px solid var(--border);
    color: var(--muted); font-family: 'Cormorant Garamond', serif;
    font-size: 0.85rem; padding: 0.4rem 1.2rem;
    cursor: pointer; border-radius: 2px; transition: all 0.2s;
  }
  .deck-modal-close:hover { border-color: var(--ink); color: var(--ink); }

  @media (max-width: 600px) {
    /* Intro screen */
    #intro-screen {
      gap: 0.5rem;
      padding: 1rem 0.75rem 1.5rem;
      overflow-x: hidden;
      align-items: center;
    }
    .intro-logo { font-size: 2.5rem; }
    .intro-title { font-size: 1.2rem; }
    .intro-sub { font-size: 0.78rem; max-width: 100%; }

    /* Deck grid â€” tighter gap on mobile (auto-fill handles columns) */
    .deck-select-section { width: 100%; max-width: 100%; box-sizing: border-box; }
    .deck-cards { gap: 0.4rem; }

    /* Deck card sizing â€” hide description to save space */
    .deck-card { padding: 0.6rem 0.5rem; }
    .deck-card-icon { font-size: 1.1rem; margin-bottom: 0.2rem; }
    .deck-card-name { font-size: 0.8rem; }
    .deck-card-sub { font-size: 0.6rem; }
    .deck-card-desc { display: none; }
    .deck-card-count { font-size: 0.58rem; margin-top: 0.2rem; }

    /* Start button */
    .start-btn { padding: 0.7rem 2rem; font-size: 0.9rem; }

    /* Header */
    .logo-text { font-size: 0.9rem; }

    /* Flashcard buttons */
    .btn-again, .btn-hard, .btn-ok, .btn-easy { font-size: 0.75rem; padding: 0.5rem 0.6rem; }
  }

  /* ========================
     HSK CONFIG OVERLAY
  ======================== */
  .hsk-config-overlay {
    position: fixed; inset: 0;
    background: rgba(26,18,8,0.6);
    z-index: 300;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
    display: flex; align-items: center; justify-content: center;
  }
  .hsk-config-overlay.open { opacity: 1; pointer-events: all; }
  .hsk-config-modal {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 2rem;
    max-width: 460px;
    width: 92%;
    max-height: 90vh;
    overflow-y: auto;
    text-align: center;
  }
  .hsk-config-back {
    display: block; background: none; border: none;
    color: var(--muted); font-family: 'Cormorant Garamond', serif;
    font-size: 0.85rem; cursor: pointer; padding: 0 0 1rem 0;
    text-align: left; transition: color 0.2s;
  }
  .hsk-config-back:hover { color: var(--ink); }
  .hsk-config-title { font-size: 1.3rem; font-weight: 300; letter-spacing: 0.08em; margin-bottom: 0.3rem; }
  .hsk-config-sub { font-size: 0.85rem; color: var(--muted); margin-bottom: 1.5rem; }
  .level-toggle-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.6rem;
    margin-bottom: 1.5rem;
  }
  .level-toggle-btn {
    border: 2px solid var(--border);
    border-radius: 2px;
    padding: 0.8rem 0.5rem;
    background: var(--paper2);
    cursor: pointer;
    font-family: 'Cormorant Garamond', serif;
    transition: all 0.2s;
    display: flex; flex-direction: column; align-items: center; gap: 0.2rem;
  }
  .level-toggle-btn:hover { border-color: var(--ink); }
  .level-toggle-btn.active { border-color: var(--red); background: var(--paper); }
  .level-toggle-btn.active .ltb-name { color: var(--red); }
  .level-toggle-btn.disabled-toggle { opacity: 0.4; cursor: not-allowed; }
  .ltb-name { font-size: 1rem; font-weight: 600; }
  .ltb-sub { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
  .ltb-count { font-size: 0.65rem; color: var(--muted); font-style: italic; }
  .hsk-stats-bar {
    display: flex; justify-content: center; gap: 2rem;
    background: var(--paper2);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 0.9rem 1rem;
    margin-bottom: 1.5rem;
  }
  .hsk-stat-item { display: flex; flex-direction: column; align-items: center; gap: 0.15rem; }
  .hsk-stat-value { font-size: 1.4rem; font-weight: 300; font-family: 'Cormorant Garamond', serif; color: var(--ink); }
  .hsk-stat-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
  .hsk-start-btn {
    width: 100%;
    background: var(--red); color: var(--paper);
    border: none; border-radius: 2px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.1rem; letter-spacing: 0.08em;
    padding: 0.9rem 1.5rem;
    cursor: pointer; transition: opacity 0.2s;
  }
  .hsk-start-btn:hover { opacity: 0.88; }
  .hsk-start-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ========================
     TEXT SIZE PICKER
  ======================== */
  .size-picker {
    display: flex;
    align-items: center;
    border: 1px solid var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .size-btn {
    background: none;
    border: none;
    border-right: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-weight: 600;
    line-height: 1;
    padding: 0.3rem 0.5rem;
    transition: background 0.15s, color 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .size-btn:last-child { border-right: none; }
  .size-btn:hover { background: var(--paper2); color: var(--ink); }
  .size-btn.active { background: var(--ink); color: var(--paper); }

  /* ========================
     VOICE PICKER MODAL
  ======================== */
  .voice-overlay {
    position: fixed; inset: 0;
    background: rgba(26,18,8,0.5);
    z-index: 300;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
    display: flex; align-items: center; justify-content: center;
  }
  .voice-overlay.open { opacity: 1; pointer-events: all; }
  .voice-modal {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 2px;
    width: min(560px, 94vw);
    max-height: 82vh;
    display: flex; flex-direction: column;
    box-shadow: 0 8px 40px rgba(0,0,0,0.18);
  }
  .voice-modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 1.1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .voice-modal-title { font-size: 0.9rem; font-weight: 600; letter-spacing: 0.06em; }
  .voice-modal-close {
    background: none; border: none; font-size: 1.1rem;
    cursor: pointer; color: var(--muted); padding: 0.2rem 0.4rem;
    transition: color 0.15s; line-height: 1;
  }
  .voice-modal-close:hover { color: var(--ink); }
  .voice-modal-intro {
    padding: 0.9rem 1.5rem 0.7rem;
    font-size: 0.8rem; color: var(--muted); line-height: 1.55;
    border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .voice-no-voices {
    padding: 2rem 1.5rem; text-align: center;
    font-size: 0.88rem; color: var(--muted); line-height: 1.6;
  }
  .voice-list {
    overflow-y: auto; flex: 1;
    padding: 0.6rem 0;
  }
  .voice-item {
    display: flex; align-items: flex-start;
    gap: 0.9rem;
    padding: 0.7rem 1.5rem;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: background 0.12s, border-color 0.12s;
  }
  .voice-item:hover { background: var(--paper2); }
  .voice-item.selected {
    border-left-color: var(--red);
    background: var(--paper2);
  }
  .voice-item-radio {
    width: 16px; height: 16px; margin-top: 2px; flex-shrink: 0;
    border: 2px solid var(--border); border-radius: 50%;
    transition: all 0.15s;
  }
  .voice-item.selected .voice-item-radio {
    border-color: var(--red);
    background: radial-gradient(circle, var(--red) 40%, transparent 41%);
  }
  .voice-item-info { flex: 1; min-width: 0; }
  .voice-item-name {
    font-size: 0.85rem; font-weight: 600;
    color: var(--ink); margin-bottom: 0.15rem;
    display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;
  }
  .voice-badge {
    font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 0.1rem 0.4rem; border-radius: 2px; font-weight: 600;
    border: 1px solid;
  }
  .voice-badge-recommended { color: var(--green); border-color: var(--green); background: rgba(45,106,79,0.07); }
  .voice-badge-neural      { color: var(--blue);  border-color: var(--blue);  background: rgba(26,74,107,0.07); }
  .voice-badge-system      { color: var(--muted); border-color: var(--border); }
  .voice-item-desc { font-size: 0.75rem; color: var(--muted); line-height: 1.45; }
  .voice-item-actions {
    display: flex; align-items: center; flex-shrink: 0;
  }
  .voice-preview-btn {
    background: none; border: 1px solid var(--border);
    border-radius: 2px; padding: 0.25rem 0.55rem;
    font-size: 0.72rem; color: var(--muted);
    cursor: pointer; font-family: 'Cormorant Garamond', serif;
    transition: all 0.15s; white-space: nowrap;
  }
  .voice-preview-btn:hover { border-color: var(--ink); color: var(--ink); }
  .voice-preview-btn.playing { border-color: var(--red); color: var(--red); }
  .voice-modal-footer {
    padding: 0.9rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0; gap: 1rem;
  }
  .voice-modal-footer-note { font-size: 0.72rem; color: var(--muted); line-height: 1.4; flex: 1; }
  .voice-modal-done {
    background: var(--ink); color: var(--paper);
    border: none; border-radius: 2px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.85rem; letter-spacing: 0.1em;
    padding: 0.5rem 1.5rem; cursor: pointer; transition: opacity 0.2s;
  }
  .voice-modal-done:hover { opacity: 0.85; }
  .voice-btn {
    background: none; border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 0.82rem; letter-spacing: 0.04em;
    padding: 0.35rem 0.75rem; cursor: pointer;
    border-radius: 2px; transition: all 0.2s; white-space: nowrap;
    display: flex; align-items: center; gap: 0.4rem;
  }
  .voice-btn:hover { border-color: var(--ink); color: var(--ink); }
  .voice-btn-name { font-size: 0.75rem; max-width: 80px; overflow: hidden; text-overflow: ellipsis; }

  /* â”€â”€ AUTH BUTTON in header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .auth-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 2px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.82rem;
    letter-spacing: 0.04em;
    padding: 0.35rem 0.75rem;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }
  .auth-btn:hover { border-color: var(--ink); color: var(--ink); }
  .auth-btn.signed-in {
    border-color: var(--green);
    color: var(--green);
    max-width: 140px;
    overflow: hidden;
  }
  .auth-btn.signed-in:hover { background: rgba(45,106,79,0.08); }
  .auth-btn-email {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100px;
    font-size: 0.75rem;
  }

  /* â”€â”€ AUTH MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .auth-overlay {
    position: fixed; inset: 0;
    background: rgba(26,18,8,0.55);
    z-index: 400;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
  }
  .auth-overlay.open { opacity: 1; pointer-events: all; }

  .auth-modal {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 4px;
    width: 92%;
    max-width: 380px;
    padding: 2rem;
    box-shadow: 0 12px 40px rgba(0,0,0,0.2);
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
  }

  .auth-modal-close {
    position: absolute;
    top: 1rem; right: 1rem;
    background: none; border: none;
    font-size: 1.1rem; cursor: pointer;
    color: var(--muted); line-height: 1;
    padding: 0.25rem;
  }
  .auth-modal-close:hover { color: var(--ink); }

  .auth-modal-logo {
    font-family: 'Noto Serif SC', serif;
    font-size: 2rem;
    color: var(--red);
    text-align: center;
    line-height: 1;
  }

  .auth-modal-title {
    font-size: 1.35rem;
    font-weight: 600;
    text-align: center;
    color: var(--ink);
    letter-spacing: 0.02em;
  }

  .auth-modal-sub {
    font-size: 0.82rem;
    color: var(--muted);
    text-align: center;
    line-height: 1.5;
    margin-top: -0.6rem;
  }

  .auth-form { display: flex; flex-direction: column; gap: 0.75rem; }

  .auth-input-label {
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.2rem;
    display: block;
  }

  .auth-input {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border: 1px solid var(--border);
    border-radius: 2px;
    background: var(--paper2);
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.95rem;
    color: var(--ink);
    transition: border-color 0.15s;
    outline: none;
  }
  .auth-input:focus { border-color: var(--red); }
  .auth-input::placeholder { color: var(--muted); opacity: 0.7; }

  .auth-submit-btn {
    width: 100%;
    padding: 0.7rem 1.2rem;
    background: var(--red);
    color: var(--paper);
    border: none;
    border-radius: 2px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: opacity 0.2s;
    margin-top: 0.25rem;
  }
  .auth-submit-btn:hover { opacity: 0.88; }
  .auth-submit-btn:disabled { opacity: 0.5; cursor: default; }

  .auth-toggle {
    font-size: 0.82rem;
    color: var(--muted);
    text-align: center;
  }
  .auth-toggle-link {
    color: var(--red);
    cursor: pointer;
    text-decoration: underline;
    background: none; border: none;
    font-family: inherit; font-size: inherit;
    padding: 0;
  }
  .auth-toggle-link:hover { opacity: 0.8; }

  .auth-error {
    font-size: 0.8rem;
    color: var(--red);
    background: rgba(192,57,43,0.08);
    border: 1px solid rgba(192,57,43,0.2);
    border-radius: 2px;
    padding: 0.5rem 0.75rem;
    text-align: center;
    display: none;
  }
  .auth-error.visible { display: block; }

  .auth-success {
    font-size: 0.82rem;
    color: var(--green);
    background: rgba(45,106,79,0.08);
    border: 1px solid rgba(45,106,79,0.2);
    border-radius: 2px;
    padding: 0.5rem 0.75rem;
    text-align: center;
    display: none;
  }
  .auth-success.visible { display: block; }

  .auth-separator {
    display: flex; align-items: center; gap: 0.75rem;
    font-size: 0.75rem; color: var(--muted); letter-spacing: 0.1em;
  }
  .auth-separator::before, .auth-separator::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  /* Sync status indicator */
  .sync-indicator {
    font-size: 0.68rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.3rem;
    opacity: 0;
    transition: opacity 0.3s;
  }
  .sync-indicator.visible { opacity: 1; }
  .sync-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--green);
    flex-shrink: 0;
  }
  .sync-dot.syncing {
    background: var(--gold);
    animation: pulse-sync 0.8s infinite alternate;
  }
  @keyframes pulse-sync { from { opacity: 1; } to { opacity: 0.3; } }

  /* â”€â”€ LOCKED DECK CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .deck-card.locked {
    opacity: 0.72;
    cursor: pointer;
    position: relative;
  }
  .deck-card.locked::after {
    content: 'ðŸ”’';
    position: absolute;
    top: 0.55rem; right: 0.6rem;
    font-size: 0.85rem;
    line-height: 1;
  }
  .deck-card.locked .deck-card-count {
    color: var(--muted);
  }
  .deck-card.coming-soon {
    opacity: 0.5;
    cursor: default;
    position: relative;
  }
  .deck-card.coming-soon::after {
    content: 'Soon';
    position: absolute;
    top: 0.55rem; right: 0.6rem;
    font-size: 0.62rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 0.1rem 0.3rem;
    background: var(--paper2);
  }
  .deck-card.unlocked-badge::after {
    content: 'âœ“';
    position: absolute;
    top: 0.55rem; right: 0.6rem;
    font-size: 0.8rem;
    color: var(--green);
    font-weight: 700;
  }

  /* â”€â”€ UPGRADE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .upgrade-overlay {
    position: fixed; inset: 0;
    background: rgba(26,18,8,0.6);
    z-index: 500;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s ease;
  }
  .upgrade-overlay.open { opacity: 1; pointer-events: all; }

  .upgrade-modal {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 4px;
    width: 92%; max-width: 400px;
    padding: 2rem;
    box-shadow: 0 12px 40px rgba(0,0,0,0.22);
    position: relative;
    display: flex; flex-direction: column; gap: 1rem;
  }

  .upgrade-modal-close {
    position: absolute; top: 1rem; right: 1rem;
    background: none; border: none;
    font-size: 1.1rem; cursor: pointer;
    color: var(--muted);
  }
  .upgrade-modal-close:hover { color: var(--ink); }

  .upgrade-modal-icon { font-size: 2.2rem; text-align: center; line-height: 1; }

  .upgrade-modal-title {
    font-size: 1.4rem; font-weight: 600;
    text-align: center; color: var(--ink);
  }

  .upgrade-modal-desc {
    font-size: 0.88rem; color: var(--muted);
    text-align: center; line-height: 1.55;
  }

  .upgrade-price-row {
    display: flex; align-items: baseline;
    justify-content: center; gap: 0.4rem;
    margin: 0.25rem 0;
  }
  .upgrade-price {
    font-size: 2rem; font-weight: 600; color: var(--ink); line-height: 1;
  }
  .upgrade-price-note {
    font-size: 0.8rem; color: var(--muted);
  }

  .upgrade-features {
    list-style: none; padding: 0;
    display: flex; flex-direction: column; gap: 0.4rem;
    font-size: 0.85rem; color: var(--muted);
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    padding: 0.85rem 0;
  }
  .upgrade-features li::before { content: 'âœ“  '; color: var(--green); font-weight: 700; }

  .upgrade-buy-btn {
    width: 100%;
    padding: 0.75rem 1.2rem;
    background: var(--ink); color: var(--paper);
    border: none; border-radius: 2px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.05rem; letter-spacing: 0.06em;
    cursor: pointer; transition: opacity 0.2s;
  }
  .upgrade-buy-btn:hover { opacity: 0.85; }
  .upgrade-buy-btn:disabled { opacity: 0.45; cursor: default; }

  .upgrade-signin-note {
    font-size: 0.78rem; color: var(--muted);
    text-align: center; line-height: 1.5;
  }
  .upgrade-signin-link {
    color: var(--red); cursor: pointer;
    background: none; border: none;
    font-family: inherit; font-size: inherit; padding: 0;
    text-decoration: underline;
  }
</style>
</head>
<body>

<!-- INTRO SCREEN -->
<div id="intro-screen">
  <div class="intro-logo">æ¼¢</div>
  <div class="intro-title">HanZen</div>
  <div class="intro-sub">Master Mandarin Chinese with spaced repetition â€” with authentic pronunciation and example sentences.</div>

  <div class="deck-select-section">
    <div class="deck-select-label">Choose your deck</div>
    <div class="deck-cards">
      <div class="deck-card selected" id="deck-card-hsk1" onclick="introDeckSelect('hsk1')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 1</div>
        <div class="deck-card-sub">Beginner</div>
        <div class="deck-card-desc">Essential everyday vocabulary for absolute beginners</div>
        <div class="deck-card-count">154 words</div>
      </div>
      <div class="deck-card" id="deck-card-hsk2" onclick="introDeckSelect('hsk2')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 2</div>
        <div class="deck-card-sub">Elementary</div>
        <div class="deck-card-desc">Simple conversations about daily life and activities</div>
        <div class="deck-card-count">151 words</div>
      </div>
      <div class="deck-card" id="deck-card-hsk3" onclick="introDeckSelect('hsk3')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 3</div>
        <div class="deck-card-sub">Pre-Intermediate</div>
        <div class="deck-card-desc">Work, travel and health in everyday situations</div>
        <div class="deck-card-count">327 words</div>
      </div>
      <div class="deck-card" id="deck-card-hsk4" onclick="introDeckSelect('hsk4')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 4</div>
        <div class="deck-card-sub">Intermediate</div>
        <div class="deck-card-desc">Abstract concepts, opinions and a wide range of topics</div>
        <div class="deck-card-count">615 words</div>
      </div>
      <div class="deck-card" id="deck-card-hsk5" onclick="introDeckSelect('hsk5')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 5</div>
        <div class="deck-card-sub">Upper-Intermediate</div>
        <div class="deck-card-desc">Newspapers, films and professional communication</div>
        <div class="deck-card-count">1316 words</div>
      </div>
      <div class="deck-card" id="deck-card-hsk6" onclick="introDeckSelect('hsk6')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 6</div>
        <div class="deck-card-sub">Advanced</div>
        <div class="deck-card-desc">Academic, literary and formal professional contexts</div>
        <div class="deck-card-count">104 words</div>
      </div>
      <div class="deck-card" id="deck-card-hsk" onclick="introDeckSelect('hsk')" style="grid-column: span 3;">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK All Levels</div>
        <div class="deck-card-sub">Complete Vocabulary Â· HSK 1â€“6</div>
        <div class="deck-card-desc">Choose which HSK levels to include. Your progress from individual level decks carries over automatically.</div>
        <div class="deck-card-count">2,667 words</div>
      </div>
      <div class="deck-card" id="deck-card-sentences" onclick="introDeckSelect('sentences')" style="grid-column: span 3;">
        <span class="deck-card-icon">ðŸ’¬</span>
        <div class="deck-card-name">Sentence Starters</div>
        <div class="deck-card-sub">Speaking Patterns</div>
        <div class="deck-card-desc">49 essential sentence patterns for natural, fluent conversation</div>
        <div class="deck-card-count">49 phrases</div>
      </div>
    </div>
  </div>

  <button class="start-btn" onclick="startApp()">å¼€å§‹å­¦ä¹  Â· Begin</button>

  <div id="intro-auth-row" style="display:none; align-items:center; gap:0.5rem; font-size:0.8rem; color:var(--muted);">
    <span id="intro-auth-label">Sign in to sync your progress across devices.</span>
    <button class="auth-toggle-link" id="intro-auth-btn" onclick="onIntroAuthClick()">Sign In</button>
  </div>
</div>

<!-- DECK CHANGE MODAL (mid-session) -->
<div class="deck-overlay" id="deck-overlay" onclick="closeDeckOverlay(event)">
  <div class="deck-modal" onclick="event.stopPropagation()">
    <div class="deck-modal-title">Switch Deck</div>
    <div class="deck-modal-sub">Select a deck to study. Your progress in each deck is saved separately.</div>
    <div class="deck-cards" style="margin-bottom:0">
      <div class="deck-card" id="modal-deck-hsk1" onclick="switchDeck('hsk1')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 1</div>
        <div class="deck-card-sub">Beginner</div>
        <div class="deck-card-count">154 words</div>
      </div>
      <div class="deck-card" id="modal-deck-hsk2" onclick="switchDeck('hsk2')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 2</div>
        <div class="deck-card-sub">Elementary</div>
        <div class="deck-card-count">151 words</div>
      </div>
      <div class="deck-card" id="modal-deck-hsk3" onclick="switchDeck('hsk3')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 3</div>
        <div class="deck-card-sub">Pre-Intermediate</div>
        <div class="deck-card-count">327 words</div>
      </div>
      <div class="deck-card" id="modal-deck-hsk4" onclick="switchDeck('hsk4')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 4</div>
        <div class="deck-card-sub">Intermediate</div>
        <div class="deck-card-count">615 words</div>
      </div>
      <div class="deck-card" id="modal-deck-hsk5" onclick="switchDeck('hsk5')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 5</div>
        <div class="deck-card-sub">Upper-Intermediate</div>
        <div class="deck-card-count">1316 words</div>
      </div>
      <div class="deck-card" id="modal-deck-hsk6" onclick="switchDeck('hsk6')">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK 6</div>
        <div class="deck-card-sub">Advanced</div>
        <div class="deck-card-count">104 words</div>
      </div>
      <div class="deck-card" id="modal-deck-hsk" onclick="switchDeck('hsk')" style="grid-column: span 3;">
        <span class="deck-card-icon">ðŸ€„</span>
        <div class="deck-card-name">HSK All Levels</div>
        <div class="deck-card-sub">Complete Vocabulary Â· HSK 1â€“6</div>
        <div class="deck-card-count">2,667 words</div>
      </div>
      <div class="deck-card" id="modal-deck-sentences" onclick="switchDeck('sentences')" style="grid-column: span 3;">
        <span class="deck-card-icon">ðŸ’¬</span>
        <div class="deck-card-name">Sentence Starters</div>
        <div class="deck-card-sub">Speaking Patterns</div>
        <div class="deck-card-count">49 phrases</div>
      </div>
    </div>
    <button class="deck-modal-close" onclick="closeDeckOverlay()">Cancel</button>
  </div>
</div>

<!-- HSK ALL LEVELS CONFIG MODAL -->
<div class="hsk-config-overlay" id="hsk-config-overlay">
  <div class="hsk-config-modal">
    <button class="hsk-config-back" onclick="closeHSKConfig()">â† Back</button>
    <div class="hsk-config-title">HSK All Levels</div>
    <div class="hsk-config-sub">Select the levels to include in your session</div>
    <div class="level-toggle-grid">
      <button class="level-toggle-btn active" data-level="1" onclick="toggleHSKLevel(1)">
        <span class="ltb-name">HSK 1</span>
        <span class="ltb-sub">Beginner</span>
        <span class="ltb-count">154 words</span>
      </button>
      <button class="level-toggle-btn active" data-level="2" onclick="toggleHSKLevel(2)">
        <span class="ltb-name">HSK 2</span>
        <span class="ltb-sub">Elementary</span>
        <span class="ltb-count">151 words</span>
      </button>
      <button class="level-toggle-btn active" data-level="3" onclick="toggleHSKLevel(3)">
        <span class="ltb-name">HSK 3</span>
        <span class="ltb-sub">Pre-Intermediate</span>
        <span class="ltb-count">327 words</span>
      </button>
      <button class="level-toggle-btn active" data-level="4" onclick="toggleHSKLevel(4)">
        <span class="ltb-name">HSK 4</span>
        <span class="ltb-sub">Intermediate</span>
        <span class="ltb-count">615 words</span>
      </button>
      <button class="level-toggle-btn active" data-level="5" onclick="toggleHSKLevel(5)">
        <span class="ltb-name">HSK 5</span>
        <span class="ltb-sub">Upper-Int.</span>
        <span class="ltb-count">1,316 words</span>
      </button>
      <button class="level-toggle-btn active" data-level="6" onclick="toggleHSKLevel(6)">
        <span class="ltb-name">HSK 6</span>
        <span class="ltb-sub">Advanced</span>
        <span class="ltb-count">104 words</span>
      </button>
    </div>
    <div class="hsk-stats-bar">
      <div class="hsk-stat-item">
        <span class="hsk-stat-value" id="hsk-stat-words">â€”</span>
        <span class="hsk-stat-label">Words</span>
      </div>
      <div class="hsk-stat-item">
        <span class="hsk-stat-value" id="hsk-stat-due">â€”</span>
        <span class="hsk-stat-label">Due Today</span>
      </div>
      <div class="hsk-stat-item">
        <span class="hsk-stat-value" id="hsk-stat-new">â€”</span>
        <span class="hsk-stat-label">New Available</span>
      </div>
    </div>
    <button class="hsk-start-btn" id="hsk-start-btn" onclick="startHSKAll()">Start Session</button>
  </div>
</div>


<!-- VOICE PICKER MODAL -->
<div class="voice-overlay" id="voice-overlay" onclick="closeVoicePicker(event)">
  <div class="voice-modal" onclick="event.stopPropagation()">
    <div class="voice-modal-header">
      <span class="voice-modal-title">ðŸ”Š Choose Voice</span>
      <button class="voice-modal-close" onclick="closeVoicePicker()">âœ•</button>
    </div>
    <div class="voice-modal-intro">
      Select the Mandarin Chinese voice used for flashcard audio. Click <strong>Preview</strong> to hear a sample.
      Available voices depend on your device and browser â€” install additional voices in your OS settings for more options.
    </div>
    <div class="voice-list" id="voice-list">
      <!-- populated by renderVoicePicker() -->
    </div>
    <div class="voice-modal-footer">
      <div class="voice-modal-footer-note">
        For best quality, use <strong>Google æ™®é€šè¯</strong> in Chrome (online), or install an Enhanced voice in your OS settings.
      </div>
      <button class="voice-modal-done" onclick="closeVoicePicker()">Done</button>
    </div>
  </div>
</div>

<!-- UPGRADE MODAL -->
<div class="upgrade-overlay" id="upgrade-overlay" onclick="closeUpgradeModal(event)">
  <div class="upgrade-modal" onclick="event.stopPropagation()">
    <button class="upgrade-modal-close" onclick="closeUpgradeModal()">âœ•</button>
    <div class="upgrade-modal-icon" id="upgrade-icon">ðŸ€„</div>
    <div class="upgrade-modal-title" id="upgrade-title">Unlock HSK 4</div>
    <div class="upgrade-modal-desc" id="upgrade-desc">One-time purchase. Yours forever.</div>
    <div class="upgrade-price-row">
      <span class="upgrade-price" id="upgrade-price">â€”</span>
      <span class="upgrade-price-note">one-time</span>
    </div>
    <ul class="upgrade-features" id="upgrade-features">
      <li>Full deck access â€” all cards</li>
      <li>Spaced repetition progress saved</li>
      <li>Works offline</li>
    </ul>
    <button class="upgrade-buy-btn" id="upgrade-buy-btn" onclick="startCheckout()">Buy Now</button>
    <div class="upgrade-signin-note" id="upgrade-signin-note"></div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="auth-overlay" id="auth-overlay" onclick="closeAuthModal(event)">
  <div class="auth-modal" onclick="event.stopPropagation()">
    <button class="auth-modal-close" onclick="closeAuthModal()">âœ•</button>
    <div class="auth-modal-logo">æ¼¢</div>
    <div class="auth-modal-title" id="auth-modal-title">Sign In</div>
    <div class="auth-modal-sub" id="auth-modal-sub">Save your progress across devices and browsers.</div>

    <div class="auth-error" id="auth-error"></div>
    <div class="auth-success" id="auth-success"></div>

    <div class="auth-form" id="auth-form">
      <div>
        <label class="auth-input-label" for="auth-email">Email</label>
        <input class="auth-input" type="email" id="auth-email" placeholder="you@example.com" autocomplete="email">
      </div>
      <div>
        <label class="auth-input-label" for="auth-password">Password</label>
        <input class="auth-input" type="password" id="auth-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')submitAuth()">
      </div>
      <button class="auth-submit-btn" id="auth-submit-btn" onclick="submitAuth()">Sign In</button>
    </div>

    <div class="auth-toggle" id="auth-toggle">
      No account? <button class="auth-toggle-link" onclick="toggleAuthMode()">Create one</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo" onclick="goHome()" title="Back to home">
    <span class="logo-char">æ¼¢</span>
    <span class="logo-text">HanZen</span>
  </div>
  <div style="display:flex;align-items:center;gap:1rem;">
    <button class="auth-btn" id="auth-header-btn" onclick="onAuthBtnClick()" title="Sign in to sync progress">ðŸ‘¤ Sign In</button>
    <span class="sync-indicator" id="sync-indicator"><span class="sync-dot" id="sync-dot"></span><span id="sync-label">Synced</span></span>
    <button class="change-deck-btn" onclick="openDeckOverlay()">â‡„ Deck</button>
    <button class="analytics-btn" onclick="openAnalytics()">ðŸ“ˆ Analytics</button>
    <div class="size-picker" title="Text size">
      <button class="size-btn" data-size="s" onclick="setTextSize('s')" style="font-size:0.7rem;">A</button>
      <button class="size-btn" data-size="m" onclick="setTextSize('m')" style="font-size:0.85rem;">A</button>
      <button class="size-btn" data-size="l" onclick="setTextSize('l')" style="font-size:1rem;">A</button>
      <button class="size-btn" data-size="xl" onclick="setTextSize('xl')" style="font-size:1.15rem;">A</button>
    </div>
    <button class="settings-trigger" onclick="openSettings()">âš™ Settings</button>
    <div class="header-stats">
    <div class="stat-item">
      <span class="stat-num" id="stat-due">0</span>
      <span class="stat-label">Due Today</span>
    </div>
    <div class="stat-item">
      <span class="stat-num" id="stat-learned">0</span>
      <span class="stat-label">Reviewed</span>
    </div>
    <div class="stat-item">
      <span class="stat-num" id="stat-streak">0</span>
      <span class="stat-label">Streak</span>
    </div>
    <button class="voice-btn" onclick="openVoicePicker()" title="Choose voice">
      <span>ðŸ”Š</span>
      <span class="voice-btn-name" id="stat-voice-name">Voice</span>
    </button>
  </div>
  </div>
</header>

<!-- LEVEL BAR -->
<div class="level-bar" id="level-bar">
  <span class="level-label">Level:</span>
  <button class="level-btn all-btn active" onclick="setLevel('all')">All HSK</button>
  <button class="level-btn" onclick="setLevel(1)">HSK 1</button>
  <button class="level-btn" onclick="setLevel(2)">HSK 2</button>
  <button class="level-btn" onclick="setLevel(3)">HSK 3</button>
  <button class="level-btn" onclick="setLevel(4)">HSK 4</button>
  <button class="level-btn" onclick="setLevel(5)">HSK 5</button>
  <button class="level-btn" onclick="setLevel(6)">HSK 6</button>
</div>

<!-- MAIN -->
<main>
  <div class="queue-info" id="queue-info">
    <div class="queue-pill">
      <div class="queue-dot" style="background:#c0392b"></div>
      <span id="q-new">0 New</span>
    </div>
    <div class="queue-pill">
      <div class="queue-dot" style="background:#1a4a6b"></div>
      <span id="q-review">0 Review</span>
    </div>
    <div class="queue-pill">
      <div class="queue-dot" style="background:#2d6a4f"></div>
      <span id="q-done">0 Done</span>
    </div>
  </div>

  <div class="progress-wrap">
    <div class="progress-fill" id="progress-fill" style="width:0%"></div>
  </div>

  <!-- CARD CONTAINER -->
  <div id="card-container" style="width:100%;max-width:600px;">
    <!-- Dynamically inserted -->
  </div>

  <!-- Rating buttons are now rendered inside the card back face dynamically -->
</main>

<div class="toast" id="toast"></div>

<!-- ANALYTICS OVERLAY -->
<div class="analytics-overlay" id="analytics-overlay" onclick="closeAnalytics()"></div>

<!-- ANALYTICS PANEL -->
<div class="analytics-panel" id="analytics-panel">
  <div class="analytics-header">
    <span class="analytics-title">ðŸ“ˆ Analytics</span>
    <button class="analytics-close" onclick="closeAnalytics()">âœ•</button>
  </div>
  <div class="analytics-body" id="analytics-body">
    <!-- Dynamically rendered by renderAnalyticsPanel() -->
  </div>
</div>

<!-- SETTINGS OVERLAY -->
<div class="settings-overlay" id="settings-overlay" onclick="closeSettings()"></div>

<!-- SETTINGS PANEL -->
<div class="settings-panel" id="settings-panel">
  <div class="settings-header">
    <span class="settings-title">âš™ Study Settings</span>
    <button class="settings-close" onclick="closeSettings()">âœ•</button>
  </div>
  <div class="settings-body">

    <div class="settings-group">
      <div class="settings-group-title">Daily Limits</div>

      <div class="setting-row">
        <div class="setting-label-row">
          <span class="setting-label">New cards per day</span>
          <span class="setting-value" id="new-cards-val">20</span>
        </div>
        <input type="range" class="setting-slider" id="new-cards-slider"
               min="5" max="100" step="5" value="20"
               oninput="updateSliderDisplay('new-cards-slider','new-cards-val')">
        <span class="setting-desc">How many brand-new words to introduce each day. Lower this if you feel overwhelmed; raise it to progress faster.</span>
      </div>

      <div class="setting-row">
        <div class="setting-label-row">
          <span class="setting-label">Reviews per day</span>
          <span class="setting-value" id="review-cards-val">âˆž</span>
        </div>
        <input type="range" class="setting-slider" id="review-cards-slider"
               min="0" max="500" step="10" value="0"
               oninput="updateSliderDisplay('review-cards-slider','review-cards-val')">
        <span class="setting-desc">Max reviews per session. Set to 0 for unlimited â€” all due cards will appear. Cap this on busy days.</span>
      </div>
    </div>

    <div class="settings-group">
      <div class="settings-group-title">About the ratings</div>
      <div class="setting-desc" style="line-height:1.65;font-style:normal;">
        <strong style="color:#c0392b;">âœ— Forgot</strong> â€” Reset to 1 day. Card reappears at end of session.<br><br>
        <strong style="color:#d35400;">â—‘ Hard</strong> â€” Interval stays short (1â€“2 days). Easiness penalised slightly.<br><br>
        <strong style="color:var(--blue);">âœ“ Remembered</strong> â€” Standard SM-2 progression.<br><br>
        <strong style="color:var(--green);">â˜… Easy</strong> â€” Longer interval boost. Easiness improved.
      </div>
    </div>

  </div>
  <button class="settings-save-btn" onclick="saveSettings()">Apply &amp; Rebuild Queue</button>
</div>

<script>
// ============================================================
// SUPABASE CONFIG
// ============================================================
// â”€â”€ SETUP: replace these two values with your own project â”€â”€
// 1. Go to https://supabase.com â†’ New Project
// 2. Settings â†’ API â†’ copy "Project URL" and "anon public" key
// 3. Run the SQL in supabase-migration.sql in the SQL editor
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL  = 'https://bcbiejyxizopaagmzhtt.supabase.co'; // e.g. 'https://xyzabcdef.supabase.co'
const SUPABASE_ANON_KEY = 'sb_publishable_m60fBOvHu2bvaot54xUufA_-D6v7sOJ'; // your anon/public key

// Internal: true once both values are filled in
const SUPABASE_CONFIGURED = SUPABASE_URL.length > 0 && SUPABASE_ANON_KEY.length > 0;

let sbClient = null;          // Supabase client instance (null if not configured)
let supabaseUser = null;       // currently signed-in user (null = guest)
let authMode = 'signin';       // 'signin' | 'signup'

// ============================================================
// DECK ENTITLEMENTS + PAYWALL
// ============================================================

// Decks that are always free â€” no purchase needed
const FREE_DECKS = new Set(['hsk1', 'hsk2', 'hsk3']);

// Decks that are not yet available for purchase
const COMING_SOON_DECKS = new Set(['hsk6']);

// Deck metadata for the upgrade modal
// prices are display strings only â€” actual amounts live in Stripe (set in GBP)
const DECK_UPGRADE_INFO = {
  hsk4:      { icon: 'ðŸ€„', title: 'Unlock HSK 4', desc: 'Intermediate Â· 615 words â€” abstract concepts, opinions, and a wide range of topics.', price: 'Â£2', features: ['615 intermediate words', 'Spaced repetition progress saved', 'Works offline'] },
  hsk5:      { icon: 'ðŸ€„', title: 'Unlock HSK 5', desc: 'Upper-Intermediate Â· 1,316 words â€” newspapers, films, and professional communication.', price: 'Â£2', features: ['1,316 upper-intermediate words', 'Spaced repetition progress saved', 'Works offline'] },
  hsk:       { icon: 'ðŸ€„', title: 'Unlock HSK All Levels', desc: 'All 2,667 words across HSK 1â€“6 in a single combined deck. Study everything in one place.', price: 'Â£5', features: ['All 2,667 words in one deck', 'Choose which levels to include', 'SRS progress from individual decks carries over', 'Works offline'] },
  sentences: { icon: 'ðŸ’¬', title: 'Unlock Sentence Starters', desc: '49 essential sentence patterns for natural, fluent conversation.', price: 'Â£2', features: ['49 conversational patterns', 'Spaced repetition progress saved', 'Works offline'] },
};

// The currently owned entitlements â€” populated after sign-in
let userEntitlements = new Set(); // e.g. Set { 'hsk4', 'hsk5' }

// The deck the upgrade modal is currently showing
let upgradeDeckId = null;

// â”€â”€ Entitlement helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function isUnlocked(deckId) {
  if (FREE_DECKS.has(deckId)) return true;
  if (userEntitlements.has(deckId)) return true;
  return false;
}

async function loadEntitlements() {
  if (!sbClient || !supabaseUser) { userEntitlements = new Set(); return; }
  try {
    const { data, error } = await sbClient
      .from('user_entitlements')
      .select('deck_id')
      .eq('user_id', supabaseUser.id);
    if (error) { console.warn('Failed to load entitlements:', error); return; }
    userEntitlements = new Set((data || []).map(r => r.deck_id));
  } catch (e) {
    console.warn('loadEntitlements error:', e);
  }
  applyLockStateToDeckCards();
}

// â”€â”€ Lock state on deck cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function applyLockStateToDeckCards() {
  const allDeckIds = ['hsk1','hsk2','hsk3','hsk4','hsk5','hsk6','hsk','sentences'];
  allDeckIds.forEach(id => {
    ['deck-card-', 'modal-deck-'].forEach(prefix => {
      const el = document.getElementById(prefix + id);
      if (!el) return;
      el.classList.remove('locked', 'unlocked-badge', 'coming-soon');
      if (COMING_SOON_DECKS.has(id)) {
        el.classList.add('coming-soon');
      } else if (isUnlocked(id)) {
        if (!FREE_DECKS.has(id)) el.classList.add('unlocked-badge');
      } else {
        el.classList.add('locked');
      }
    });
  });
}

// â”€â”€ Upgrade modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openUpgradeModal(deckId) {
  upgradeDeckId = deckId;
  const info = DECK_UPGRADE_INFO[deckId];
  if (!info) return;

  document.getElementById('upgrade-icon').textContent  = info.icon;
  document.getElementById('upgrade-title').textContent = info.title;
  document.getElementById('upgrade-desc').textContent  = info.desc;
  document.getElementById('upgrade-price').textContent = info.price;

  const featuresList = document.getElementById('upgrade-features');
  featuresList.innerHTML = info.features.map(f => `<li>${f}</li>`).join('');

  const noteEl  = document.getElementById('upgrade-signin-note');
  const buyBtn  = document.getElementById('upgrade-buy-btn');

  if (!supabaseUser) {
    noteEl.innerHTML = 'Please <button class="upgrade-signin-link" onclick="closeUpgradeModal();openAuthModal(\'signin\')">sign in</button> to purchase.';
    buyBtn.disabled = true;
  } else {
    noteEl.textContent = '';
    buyBtn.disabled = false;
  }

  document.getElementById('upgrade-overlay').classList.add('open');
}

function closeUpgradeModal(e) {
  if (e && e.target !== document.getElementById('upgrade-overlay')) return;
  document.getElementById('upgrade-overlay').classList.remove('open');
  upgradeDeckId = null;
}

// â”€â”€ Stripe checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function startCheckout() {
  if (!supabaseUser || !upgradeDeckId) return;

  const btn = document.getElementById('upgrade-buy-btn');
  btn.disabled = true;
  btn.textContent = 'Loadingâ€¦';

  try {
    // Call our Supabase Edge Function to create a Stripe Checkout session
    const { data: { session: authSession } } = await sbClient.auth.getSession();
    const token = authSession?.access_token;
    if (!token) throw new Error('No auth token');

    const res = await fetch(
      `${SUPABASE_URL}/functions/v1/create-checkout-session`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          'apikey': SUPABASE_ANON_KEY,
        },
        body: JSON.stringify({ deck_id: upgradeDeckId }),
      }
    );

    let json;
    try { json = await res.json(); } catch(e) { throw new Error(`Server returned non-JSON (status ${res.status})`); }

    console.log('Checkout response:', res.status, json); // helpful for debugging
    if (!res.ok || !json.url) {
      throw new Error(json.error || json.message || `Server error ${res.status}`);
    }

    // Redirect to Stripe Checkout
    window.location.href = json.url;

  } catch (err) {
    console.error('Checkout error:', err);
    btn.disabled = false;
    btn.textContent = 'Buy Now';
    showToast('Error: ' + err.message);
  }
}

// â”€â”€ Handle return from Stripe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function handlePaymentReturn() {
  const params = new URLSearchParams(window.location.search);
  const status = params.get('payment');
  const deck   = params.get('deck');

  if (!status) return;

  // Clean the URL so refresh doesn't re-trigger this
  const cleanUrl = window.location.pathname;
  window.history.replaceState({}, '', cleanUrl);

  if (status === 'success' && deck) {
    // Reload entitlements from Supabase â€” webhook should have inserted by now
    setTimeout(async () => {
      await loadEntitlements();
      const info = DECK_UPGRADE_INFO[deck];
      showToast(`âœ“ ${info ? info.title.replace('Unlock ', '') : deck} unlocked!`);
    }, 1500); // small delay to let webhook complete
  } else if (status === 'cancelled') {
    showToast('Payment cancelled');
  }
}
let syncTimeout = null;        // debounce handle for cloud saves

// ============================================================
// SUPABASE INIT
// ============================================================
function initSupabase() {
  if (!SUPABASE_CONFIGURED) return; // silently skip if unconfigured

  // Guard: Supabase CDN may not have loaded yet
  if (!window.supabase || !window.supabase.createClient) {
    console.warn('Supabase CDN not loaded â€” auth disabled');
    return;
  }

  // Show the Sign In button immediately â€” don't wait for getSession()
  updateAuthHeaderButton();

  // createClient is on window.supabase from the CDN bundle
  const { createClient } = window.supabase;
  sbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Listen for auth changes (login, logout, token refresh)
  sbClient.auth.onAuthStateChange((event, session) => {
    const prevUser = supabaseUser;
    supabaseUser = session ? session.user : null;

    if (supabaseUser && !prevUser) {
      // Just signed in
      onUserSignedIn(event === 'SIGNED_IN');
    } else if (!supabaseUser && prevUser) {
      // Just signed out
      onUserSignedOut();
    }

    updateAuthHeaderButton();
  });

  // Restore session from existing cookie/localStorage token
  sbClient.auth.getSession().then(({ data: { session } }) => {
    supabaseUser = session ? session.user : null;
    updateAuthHeaderButton();
  });
}

// ============================================================
// AUTH HEADER BUTTON
// ============================================================
function updateAuthHeaderButton() {
  const btn = document.getElementById('auth-header-btn');
  const introRow = document.getElementById('intro-auth-row');
  const introLabel = document.getElementById('intro-auth-label');
  const introBtn = document.getElementById('intro-auth-btn');

  if (!SUPABASE_CONFIGURED) {
    if (btn) btn.style.display = 'none';
    if (introRow) introRow.style.display = 'none';
    return;
  }

  if (supabaseUser) {
    const email = supabaseUser.email || '';
    // Header button
    if (btn) {
      btn.classList.add('signed-in');
      btn.innerHTML = `âœ“ <span class="auth-btn-email" title="${email}">${email}</span>`;
      btn.title = `Signed in as ${email} â€” click to sign out`;
    }
    // Intro row
    if (introRow) {
      introRow.style.display = 'flex';
      if (introLabel) introLabel.textContent = `Signed in as ${email}.`;
      if (introBtn) introBtn.textContent = 'Sign Out';
    }
  } else {
    // Header button
    if (btn) {
      btn.classList.remove('signed-in');
      btn.innerHTML = 'ðŸ‘¤ Sign In';
      btn.title = 'Sign in to sync progress across devices';
    }
    // Intro row
    if (introRow) {
      introRow.style.display = 'flex';
      if (introLabel) introLabel.textContent = 'Sign in to sync your progress across devices.';
      if (introBtn) introBtn.textContent = 'Sign In';
    }
  }
}

function onIntroAuthClick() {
  if (supabaseUser) {
    if (confirm('Sign out of ' + supabaseUser.email + '?')) handleSignOut();
  } else {
    openAuthModal('signin');
  }
}

function onAuthBtnClick() {
  if (supabaseUser) {
    // Signed in â†’ sign out
    if (confirm('Sign out of ' + supabaseUser.email + '?')) handleSignOut();
  } else {
    openAuthModal();
  }
}

// ============================================================
// AUTH MODAL
// ============================================================
function openAuthModal(mode) {
  authMode = mode || 'signin';
  renderAuthModal();
  document.getElementById('auth-overlay').classList.add('open');
  setTimeout(() => {
    const emailInput = document.getElementById('auth-email');
    if (emailInput) emailInput.focus();
  }, 100);
}

function closeAuthModal(e) {
  if (e && e.target !== document.getElementById('auth-overlay')) return;
  document.getElementById('auth-overlay').classList.remove('open');
}

function renderAuthModal() {
  const isSignUp = authMode === 'signup';
  document.getElementById('auth-modal-title').textContent  = isSignUp ? 'Create Account' : 'Sign In';
  document.getElementById('auth-modal-sub').textContent    = isSignUp
    ? 'Your progress will be saved to the cloud automatically.'
    : 'Save your progress across devices and browsers.';
  document.getElementById('auth-submit-btn').textContent   = isSignUp ? 'Create Account' : 'Sign In';
  document.getElementById('auth-toggle').innerHTML = isSignUp
    ? 'Already have an account? <button class="auth-toggle-link" onclick="toggleAuthMode()">Sign in</button>'
    : 'No account? <button class="auth-toggle-link" onclick="toggleAuthMode()">Create one</button>';
  clearAuthMessages();

  // Update autocomplete hint for password field
  const pwdInput = document.getElementById('auth-password');
  if (pwdInput) pwdInput.autocomplete = isSignUp ? 'new-password' : 'current-password';
}

function toggleAuthMode() {
  authMode = authMode === 'signin' ? 'signup' : 'signin';
  renderAuthModal();
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.classList.add('visible');
  document.getElementById('auth-success').classList.remove('visible');
}

function showAuthSuccess(msg) {
  const el = document.getElementById('auth-success');
  el.textContent = msg;
  el.classList.add('visible');
  document.getElementById('auth-error').classList.remove('visible');
}

function clearAuthMessages() {
  document.getElementById('auth-error').classList.remove('visible');
  document.getElementById('auth-success').classList.remove('visible');
}

async function submitAuth() {
  if (!sbClient) return;
  const email    = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const btn      = document.getElementById('auth-submit-btn');

  if (!email || !password) { showAuthError('Please enter your email and password.'); return; }
  if (password.length < 6) { showAuthError('Password must be at least 6 characters.'); return; }

  btn.disabled = true;
  clearAuthMessages();

  try {
    let result;
    if (authMode === 'signup') {
      result = await sbClient.auth.signUp({ email, password });
    } else {
      result = await sbClient.auth.signInWithPassword({ email, password });
    }

    if (result.error) {
      showAuthError(result.error.message);
      btn.disabled = false;
      return;
    }

    if (authMode === 'signup' && !result.data.session) {
      // Email confirmation required
      showAuthSuccess('Check your email to confirm your account, then sign in.');
      btn.disabled = false;
      return;
    }

    // Success â€” onAuthStateChange will fire and handle the rest
    document.getElementById('auth-overlay').classList.remove('open');
  } catch (err) {
    showAuthError('Something went wrong. Please try again.');
    btn.disabled = false;
  }
}

async function handleSignOut() {
  if (!sbClient) return;
  await sbClient.auth.signOut();
  // onAuthStateChange handles the UI update
  showToast('Signed out â€” progress saved locally');
}

// ============================================================
// STATE SYNC (Supabase â†” localStorage)
// ============================================================
const SRS_TABLE = 'user_srs_state';

async function onUserSignedIn(isFreshLogin) {
  if (!sbClient || !supabaseUser) return;

  // Load purchased decks first so lock state updates immediately
  await loadEntitlements();

  try {
    // Check if the user has existing state on the server
    const { data, error } = await sbClient
      .from(SRS_TABLE)
      .select('state, updated_at')
      .eq('user_id', supabaseUser.id)
      .maybeSingle();

    if (error) { console.warn('Supabase fetch error:', error); return; }

    if (data && data.state) {
      // Server has saved state â€” decide whether to use it
      const serverState = data.state;
      const serverCards = Object.keys(serverState.cards || {}).length;
      const localCards  = Object.keys(state.cards || {}).length;

      if (serverCards === 0 && localCards > 0) {
        // Server is empty, local has data â†’ push local to server
        await pushStateToServer();
        showToast('Progress saved to cloud â˜');
      } else if (serverCards > 0 && localCards === 0) {
        // Local is empty, server has data â†’ load server
        mergeServerState(serverState);
        showToast('Progress loaded from cloud â˜');
      } else if (serverCards > 0 && localCards > 0) {
        // Both have data â€” use whichever was updated more recently
        const serverUpdated = new Date(data.updated_at).getTime();
        const localStudyDate = state.session.lastStudyDate
          ? new Date(state.session.lastStudyDate).getTime()
          : 0;

        if (serverUpdated > localStudyDate) {
          mergeServerState(serverState);
          showToast('Progress synced from cloud â˜');
        } else {
          await pushStateToServer();
          showToast('Local progress saved to cloud â˜');
        }
      } else {
        // Both empty â€” nothing to do
        showToast('Signed in Â· Progress will be saved to cloud â˜');
      }
    } else {
      // No server record â€” push current local state
      await pushStateToServer();
      showToast('Progress saved to cloud â˜');
    }

    updateSyncIndicator('synced');
  } catch (err) {
    console.warn('Auth sync error:', err);
  }
}

function onUserSignedOut() {
  updateSyncIndicator('hidden');
  showToast('Signed out');
}

function mergeServerState(serverState) {
  // Replace local state with server state and persist locally too
  state.cards   = serverState.cards   ?? state.cards;
  state.session = { ...state.session, ...(serverState.session ?? {}) };
  state.settings= { ...state.settings, ...(serverState.settings ?? {}) };
  if (serverState.history) {
    state.history.ratingCounts = { ...state.history.ratingCounts, ...(serverState.history.ratingCounts ?? {}) };
    state.history.dailyLog     = { ...(serverState.history.dailyLog ?? {}) };
  }
  try { localStorage.setItem(STATE_KEY, JSON.stringify(state)); } catch(e) {}
  // Rebuild queue with new data
  if (typeof buildQueue === 'function') { buildQueue(); updateStats(); }
}

async function pushStateToServer() {
  if (!sbClient || !supabaseUser) return;
  try {
    const { error } = await sbClient
      .from(SRS_TABLE)
      .upsert({
        user_id: supabaseUser.id,
        state: state,
        updated_at: new Date().toISOString()
      }, { onConflict: 'user_id' });

    if (error) console.warn('Supabase save error:', error);
  } catch (err) {
    console.warn('Supabase save exception:', err);
  }
}

// Debounced cloud save â€” called from saveState()
function scheduleSyncToServer() {
  if (!sbClient || !supabaseUser) return;
  clearTimeout(syncTimeout);
  updateSyncIndicator('syncing');
  syncTimeout = setTimeout(async () => {
    await pushStateToServer();
    updateSyncIndicator('synced');
  }, 1500); // batch rapid saves into one request
}

// Sync status indicator (small dot near header)
function updateSyncIndicator(status) {
  const indicator = document.getElementById('sync-indicator');
  const dot       = document.getElementById('sync-dot');
  const label     = document.getElementById('sync-label');
  if (!indicator) return;

  if (status === 'hidden' || !supabaseUser) {
    indicator.classList.remove('visible');
  } else {
    indicator.classList.add('visible');
    if (status === 'syncing') {
      dot.classList.add('syncing');
      label.textContent = 'Syncingâ€¦';
    } else {
      dot.classList.remove('syncing');
      label.textContent = 'Synced';
    }
  }
}

// ============================================================
// HSK VOCABULARY DATABASE
// ============================================================
// ============================================================
// DECK DATA CACHE  (loaded from JSON files at startup)
// ============================================================
const DECK_CACHE = { hsk: {}, sentences: [] };

async function loadAllDecks() {
  const [h1, h2, h3, h4, h5, h6, sent] = await Promise.all([
    fetch('data/hsk1.json').then(r => r.json()),
    fetch('data/hsk2.json').then(r => r.json()),
    fetch('data/hsk3.json').then(r => r.json()),
    fetch('data/hsk4.json').then(r => r.json()),
    fetch('data/hsk5.json').then(r => r.json()),
    fetch('data/hsk6.json').then(r => r.json()),
    fetch('data/sentences.json').then(r => r.json()),
  ]);
  DECK_CACHE.hsk = { 1: h1, 2: h2, 3: h3, 4: h4, 5: h5, 6: h6 };
  DECK_CACHE.sentences = sent;
}


// ============================================================
// SM-2 ALGORITHM
// ============================================================
function sm2(card, quality) {
  // quality: 0=forgot, 2=hard, 3=good, 5=easy
  let { interval, repetitions, easiness } = card.srs;

  if (quality === 0) {
    // Forgot: full reset
    repetitions = 0;
    interval = 1;
  } else if (quality === 2) {
    // Hard: keep repetitions but give a short interval (1 or 2 days)
    // Don't advance the repetition count fully â€” clamp interval growth
    interval = Math.max(1, Math.min(2, Math.round(interval * 0.5)));
    // Don't increment repetitions so the card doesn't escalate too fast
  } else {
    // Good (3) or Easy (5): standard SM-2 progression
    if (repetitions === 0) interval = 1;
    else if (repetitions === 1) interval = 6;
    else interval = Math.round(interval * easiness);
    repetitions += 1;
  }

  // Update easiness factor (applies to all ratings)
  easiness = Math.max(1.3, easiness + 0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));

  const now = new Date();
  const nextDate = new Date(now);
  nextDate.setDate(now.getDate() + interval);

  return {
    interval,
    repetitions,
    easiness,
    nextReview: nextDate.toISOString(),
    lastReview: now.toISOString()
  };
}

// ============================================================
// APP STATE
// ============================================================
const STATE_KEY = 'hsk_srs_v1';
let state = {
  cards: {}, // { "hsk1_0": { srs: {...}, lastRating: 3 } }
  session: {
    reviewed: 0,
    streak: 0,
    longestStreak: 0,
    lastStudyDate: null,
  },
  settings: {
    newCardsPerDay: 20,
    reviewCardsPerDay: 0, // 0 = unlimited
  },
  history: {
    ratingCounts: { forgot: 0, hard: 0, good: 0, easy: 0 },
    dailyLog: {} // { "YYYY-MM-DD": { reviews: N, newCards: N } }
  }
};

function saveState() {
  try { localStorage.setItem(STATE_KEY, JSON.stringify(state)); } catch(e) {}
  scheduleSyncToServer(); // no-op if not signed in
}

function loadState() {
  try {
    const raw = localStorage.getItem(STATE_KEY);
    if (raw) {
      const loaded = JSON.parse(raw);
      // Deep merge to preserve default structure
      state.cards   = loaded.cards   ?? {};
      state.session = { ...state.session, ...(loaded.session ?? {}) };
      state.settings = { ...state.settings, ...(loaded.settings ?? {}) };
      if (loaded.history) {
        state.history.ratingCounts = { ...state.history.ratingCounts, ...(loaded.history.ratingCounts ?? {}) };
        state.history.dailyLog     = { ...(loaded.history.dailyLog ?? {}) };
      }
    }
  } catch(e) {}
}

// ============================================================
// SETTINGS PANEL
// ============================================================
function openSettings() {
  // Sync sliders to current values before opening
  const newSlider = document.getElementById('new-cards-slider');
  const revSlider = document.getElementById('review-cards-slider');
  if (newSlider) {
    newSlider.value = state.settings.newCardsPerDay ?? 20;
    updateSliderDisplay('new-cards-slider', 'new-cards-val');
  }
  if (revSlider) {
    revSlider.value = state.settings.reviewCardsPerDay ?? 0;
    updateSliderDisplay('review-cards-slider', 'review-cards-val');
  }
  document.getElementById('settings-panel').classList.add('open');
  document.getElementById('settings-overlay').classList.add('open');
}

function closeSettings() {
  document.getElementById('settings-panel').classList.remove('open');
  document.getElementById('settings-overlay').classList.remove('open');
}

function updateSliderDisplay(sliderId, valId) {
  const slider = document.getElementById(sliderId);
  const valEl  = document.getElementById(valId);
  if (!slider || !valEl) return;
  const v = parseInt(slider.value);
  if (sliderId === 'review-cards-slider') {
    valEl.textContent = v === 0 ? 'âˆž' : v;
  } else {
    valEl.textContent = v;
  }
}

function saveSettings() {
  const newVal = parseInt(document.getElementById('new-cards-slider').value);
  const revVal = parseInt(document.getElementById('review-cards-slider').value);
  state.settings.newCardsPerDay    = newVal;
  state.settings.reviewCardsPerDay = revVal;
  saveState();
  closeSettings();
  // Rebuild queue with new limits and restart
  currentCardIdx = 0;
  sessionReviewed = 0;
  buildQueue();
  showCard();
  synth.cancel();
  showToast(`Settings saved â€” ${newVal} new Â· ${revVal === 0 ? 'âˆž' : revVal} reviews`);
}

function getCardKey(level, idx) {
  if (level === 'sentences') return `sent_${idx}`;
  return `hsk${level}_${idx}`;
}

function getCardSRS(level, idx) {
  const key = getCardKey(level, idx);
  if (!state.cards[key]) {
    state.cards[key] = {
      srs: { interval: 0, repetitions: 0, easiness: 2.5, nextReview: null, lastReview: null }
    };
  }
  return state.cards[key].srs;
}

function isDue(srs) {
  if (!srs.nextReview) return true; // new card
  return new Date(srs.nextReview) <= new Date();
}

// ============================================================
// CURRENT SESSION
// ============================================================
let currentDeck = 'hsk1';      // 'hsk1'-'hsk6' | 'sentences'
let currentLevel = 'all';
let queue = [];
let currentCardIdx = 0;
let isFlipped = false;
let sessionReviewed = 0;
let audioQueue = [];
let audioPlaying = false;

function buildQueue() {
  queue = [];
  const newCards = [];
  const reviewCards = [];

  if (currentDeck === 'sentences') {
    DECK_CACHE.sentences.forEach((word, idx) => {
      const srs = getCardSRS('sentences', idx);
      const item = { level: 'sentences', idx, word, srs };
      if (!srs.nextReview) newCards.push(item);
      else if (isDue(srs)) reviewCards.push(item);
    });
  } else if (currentDeck === 'hsk') {
    for (const level of selectedHSKLevels) {
      const words = DECK_CACHE.hsk[level] || [];
      words.forEach((word, idx) => {
        const srs = getCardSRS(level, idx);
        const item = { level, idx, word, srs };
        if (!srs.nextReview) newCards.push(item);
        else if (isDue(srs)) reviewCards.push(item);
      });
    }
  } else {
    const level = parseInt(currentDeck.replace('hsk', ''));
    const words = DECK_CACHE.hsk[level] || [];
    words.forEach((word, idx) => {
      const srs = getCardSRS(level, idx);
      const item = { level, idx, word, srs };
      if (!srs.nextReview) newCards.push(item);
      else if (isDue(srs)) reviewCards.push(item);
    });
  }

  const maxNew    = state.settings.newCardsPerDay ?? 20;
  const maxReview = state.settings.reviewCardsPerDay ?? 0; // 0 = unlimited

  const limitedNew    = newCards.slice(0, maxNew);
  const limitedReview = maxReview === 0 ? reviewCards : reviewCards.slice(0, maxReview);

  // Reviews first, then new cards
  queue = [...limitedReview, ...limitedNew];

  updateStats();
  return queue;
}

function updateStats() {
  let totalNew = 0, dueCount = 0, doneCount = 0;

  if (currentDeck === 'sentences') {
    DECK_CACHE.sentences.forEach((_, idx) => {
      const srs = getCardSRS('sentences', idx);
      if (!srs.nextReview) totalNew++;
      else if (isDue(srs)) dueCount++;
      else doneCount++;
    });
  } else if (currentDeck === 'hsk') {
    for (const level of selectedHSKLevels) {
      const words = DECK_CACHE.hsk[level] || [];
      words.forEach((word, idx) => {
        const srs = getCardSRS(level, idx);
        if (!srs.nextReview) totalNew++;
        else if (isDue(srs)) dueCount++;
        else doneCount++;
      });
    }
  } else {
    const level = parseInt(currentDeck.replace('hsk', ''));
    const words = DECK_CACHE.hsk[level] || [];
    words.forEach((word, idx) => {
      const srs = getCardSRS(level, idx);
      if (!srs.nextReview) totalNew++;
      else if (isDue(srs)) dueCount++;
      else doneCount++;
    });
  }

  const maxNew    = state.settings.newCardsPerDay ?? 20;
  const maxReview = state.settings.reviewCardsPerDay ?? 0;
  const cappedNew    = Math.min(totalNew, maxNew);
  const cappedReview = maxReview === 0 ? dueCount : Math.min(dueCount, maxReview);

  document.getElementById('stat-due').textContent = queue.length;
  document.getElementById('stat-learned').textContent = sessionReviewed;
  document.getElementById('q-new').textContent = `${cappedNew} New`;
  document.getElementById('q-review').textContent = `${cappedReview}${maxReview > 0 ? '/'+maxReview : ''} Review`;
  document.getElementById('q-done').textContent = `${doneCount} Done`;
  document.getElementById('stat-streak').textContent = state.session.streak || 0;
}

function showCard() {
  isFlipped = false;

  if (currentCardIdx >= queue.length || queue.length === 0) {
    showEmptyState();
    return;
  }

  const item = queue[currentCardIdx];
  const { word, level } = item;
  const progress = queue.length > 0 ? (currentCardIdx / queue.length) * 100 : 0;
  document.getElementById('progress-fill').style.width = progress + '%';

  // Branch to sentence card renderer for sentence deck
  if (currentDeck === 'sentences') {
    buildSentenceCardHTML(item);
    return;
  }

  const container = document.getElementById('card-container');
  container.innerHTML = `
    <div class="card-scene" id="card-scene">
      <div class="card" id="main-card" onclick="flipCard()">
        <!-- FRONT -->
        <div class="card-face card-front" id="card-front-face">
          <div class="card-front-inner">
            <span class="hsk-badge">HSK ${level}</span>
            <span class="card-number">${currentCardIdx + 1} / ${queue.length}</span>
            <div class="char-display">
              <div class="simplified">${word.simp}</div>
              <div class="trad-label">Traditional</div>
              <div class="traditional">${word.trad}</div>
            </div>
            <div class="tap-hint">tap to reveal</div>
          </div>
        </div>

        <!-- BACK -->
        <div class="card-face card-back" id="card-back-face">
          <div class="card-back-inner">
            <div class="back-header">
              <div class="back-chars">
                <div class="back-simplified">${word.simp}</div>
                <div class="back-traditional">Traditional: ${word.trad}</div>
              </div>
              <div style="text-align:right;">
                <div class="pinyin-display">${word.pinyin}</div>
                <div class="meaning-display">${word.meaning}</div>
              </div>
            </div>

            <!-- AUDIO ROW -->
            <div class="audio-row">
              <button class="audio-btn" id="word-audio-btn" onclick="event.stopPropagation(); speakWord()">
                <span class="speaker-icon">ðŸ”Š</span> Speak word
              </button>
              <button class="audio-btn" id="sent-audio-btn" onclick="event.stopPropagation(); speakSentence()">
                <span class="speaker-icon">ðŸ”Š</span> Speak sentence
              </button>
            </div>

            <!-- EXAMPLE -->
            <div class="section-divider"><span class="section-label">Example sentence</span></div>
            <div class="example-block">
              <div class="example-zh">${highlightWord(word.example_zh, word.simp)}</div>
              <div class="example-pinyin">${word.example_py}</div>
              <div class="example-en">${word.example_en}</div>
            </div>

            <!-- CHARACTER BREAKDOWN -->
            ${word.chars && word.chars.length > 1 ? `
            <div class="section-divider"><span class="section-label">Character breakdown</span></div>
            <div class="char-breakdown">
              ${word.chars.map(c => `
                <div class="char-card">
                  <div class="char-card-zh">${c.s}</div>
                  <div class="char-card-tc">${c.t !== c.s ? c.t : ''}</div>
                  <div class="char-card-meaning">${c.m}</div>
                </div>
              `).join('')}
            </div>
            ` : ''}

            <!-- RATING BUTTONS â€” embedded in card back -->
            <div class="rating-section" id="rating-section">
              <div class="rating-label">How well did you recall?</div>
              <div class="rating-btns">
                <button class="rating-btn forgot" onclick="event.stopPropagation(); rateCard(0)">
                  âœ— Forgot
                  <span class="sub">Again soon</span>
                </button>
                <button class="rating-btn hard" onclick="event.stopPropagation(); rateCard(2)">
                  â—‘ Hard
                  <span class="sub">Short interval</span>
                </button>
                <button class="rating-btn remembered" onclick="event.stopPropagation(); rateCard(3)">
                  âœ“ Good
                  <span class="sub">Standard</span>
                </button>
                <button class="rating-btn easy" onclick="event.stopPropagation(); rateCard(5)">
                  â˜… Easy
                  <span class="sub">Boost</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  // Set card height to front face height initially.
  // After a small delay (DOM paint), measure both faces and set the card
  // wrapper height to whichever is taller â€” this prevents the back face
  // from being clipped or the scene from collapsing to zero.
  requestAnimationFrame(() => {
    const frontFace = document.getElementById('card-front-face');
    const backFace  = document.getElementById('card-back-face');
    const card      = document.getElementById('main-card');
    if (frontFace && backFace && card) {
      const h = Math.max(frontFace.scrollHeight, backFace.scrollHeight);
      card.style.height = h + 'px';
    }
  });
}

function buildSentenceCardHTML(item) {
  const { word } = item;
  const container = document.getElementById('card-container');
  container.innerHTML = `
    <div class="card-scene" id="card-scene">
      <div class="card" id="main-card" onclick="flipCard()">
        <!-- FRONT -->
        <div class="card-face card-front" id="card-front-face">
          <div class="card-front-inner">
            <span class="sentence-badge">Sentence Starter</span>
            <span class="card-number">${currentCardIdx + 1} / ${queue.length}</span>
            <div class="char-display">
              <div class="sentence-front-phrase">${word.simp}</div>
              <div class="sentence-front-trad">${word.trad}</div>
            </div>
            <div class="tap-hint">tap to reveal</div>
          </div>
        </div>

        <!-- BACK -->
        <div class="card-face card-back" id="card-back-face">
          <div class="card-back-inner">
            <div class="back-header">
              <div class="back-chars">
                <div class="back-simplified" style="font-size:1.6rem;">${word.simp}</div>
                <div class="back-traditional" style="font-size:1rem; color: var(--ink-light);">${word.trad}</div>
                <div style="font-size:0.8rem; color: var(--ink-faint); margin-top:0.2rem;">${word.pinyin}</div>
              </div>
              <div style="text-align:right;">
                <div class="sentence-meaning">${word.meaning}</div>
              </div>
            </div>

            <!-- AUDIO ROW -->
            <div class="audio-row">
              <button class="audio-btn" id="word-audio-btn" onclick="event.stopPropagation(); speakWord()">
                <span class="speaker-icon">ðŸ”Š</span> Speak phrase
              </button>
              <button class="audio-btn" id="sent-audio-btn" onclick="event.stopPropagation(); speakSentence()">
                <span class="speaker-icon">ðŸ”Š</span> Speak example
              </button>
            </div>

            <!-- EXAMPLE -->
            <div class="section-divider"><span class="section-label">Example sentence</span></div>
            <div class="example-block">
              <div class="example-zh">${word.example_zh}</div>
              <div class="example-pinyin">${word.example_py}</div>
              <div class="example-en">${word.example_en}</div>
            </div>

            <!-- RATING BUTTONS -->
            <div class="rating-section" id="rating-section">
              <div class="rating-label">How well did you recall?</div>
              <div class="rating-btns">
                <button class="rating-btn forgot" onclick="event.stopPropagation(); rateCard(0)">
                  âœ— Forgot
                  <span class="sub">Again soon</span>
                </button>
                <button class="rating-btn hard" onclick="event.stopPropagation(); rateCard(2)">
                  â—‘ Hard
                  <span class="sub">Short interval</span>
                </button>
                <button class="rating-btn remembered" onclick="event.stopPropagation(); rateCard(3)">
                  âœ“ Good
                  <span class="sub">Standard</span>
                </button>
                <button class="rating-btn easy" onclick="event.stopPropagation(); rateCard(5)">
                  â˜… Easy
                  <span class="sub">Boost</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  requestAnimationFrame(() => {
    const frontFace = document.getElementById('card-front-face');
    const backFace  = document.getElementById('card-back-face');
    const card      = document.getElementById('main-card');
    if (frontFace && backFace && card) {
      const h = Math.max(frontFace.scrollHeight, backFace.scrollHeight);
      card.style.height = h + 'px';
    }
  });
}

function highlightWord(sentence, word) {
  return sentence.replace(word, `<span class="highlight-word">${word}</span>`);
}

function flipCard() {
  if (isFlipped) return;
  isFlipped = true;
  const card = document.getElementById('main-card');
  card.classList.add('flipped');

  // Auto-play audio sequence: word first, then sentence
  setTimeout(() => {
    autoPlaySequence();
  }, 650);
}

// ============================================================
// WEB SPEECH API â€” Best quality Chinese voice selection
// ============================================================
let synth = window.speechSynthesis;
let voices = [];
let preferredVoice = null;

// Voice quality ranking â€” higher index = higher preference
// We score voices by name patterns known to be high quality
const VOICE_QUALITY_HINTS = [
  // Google's neural zh-CN voices (best available in Chrome)
  'google æ™®é€šè¯', 'google chinese', 'google zh',
  // macOS high-quality voices
  'tingting', 'ting-ting', 'meijia', 'mei-jia', 'lekiu',
  'sin-ji', 'sinji',
  // Windows neural voices
  'xiaoxiao', 'yunxi', 'yunyang', 'xiaohan', 'xiaomeng',
  'xiaomo', 'xiaorui', 'xiaoshuang', 'xiaoyan', 'xiaoyou',
  'yunjian', 'yunfeng', 'yunhao', 'yunxia', 'xiaozhen',
  // Older but decent voices
  'huihui', 'kangkang', 'yaoyao',
  // Generic zh-CN fallback
  'zh-cn',
];

function scoreVoice(v) {
  const name = v.name.toLowerCase();
  const lang = v.lang.toLowerCase();
  // Must be Chinese
  if (!lang.startsWith('zh')) return -1;
  // Google zh-CN is the clear winner â€” give it an overwhelming lead
  if (name.includes('google') && lang === 'zh-cn') return 1000;
  // Prefer zh-CN (Mandarin mainland) over zh-TW
  let score = lang === 'zh-cn' ? 10 : lang.startsWith('zh') ? 5 : 0;
  // Bonus for name matches
  for (let i = 0; i < VOICE_QUALITY_HINTS.length; i++) {
    if (name.includes(VOICE_QUALITY_HINTS[i])) {
      score += i + 1; // higher-indexed hints score more
    }
  }
  // Prefer non-compact / non-light variants
  if (name.includes('compact') || name.includes('light')) score -= 3;
  // Prefer premium/enhanced/neural
  if (name.includes('premium') || name.includes('enhanced') || name.includes('neural')) score += 5;
  return score;
}

let allChineseVoices = [];
let voiceIndex = 0;

function loadVoices() {
  voices = synth.getVoices();
  const chinese = voices.filter(v => v.lang.toLowerCase().startsWith('zh') || v.lang.toLowerCase().includes('zh'));
  if (chinese.length === 0) {
    preferredVoice = null;
    updateVoiceDisplay();
    return;
  }
  // Sort by score descending
  allChineseVoices = [...chinese].sort((a, b) => scoreVoice(b) - scoreVoice(a));
  preferredVoice = allChineseVoices[voiceIndex] || allChineseVoices[0];

  console.log('Available Chinese voices:', allChineseVoices.map(v => `${v.name} [${v.lang}] score=${scoreVoice(v)}`));
  console.log('Selected voice:', preferredVoice?.name, preferredVoice?.lang);
  updateVoiceDisplay();
}

function shortVoiceName(v) {
  return v.name
    .replace(/^Microsoft\s+/i, '')
    .replace(/^Google\s+/i, 'Google ')
    .replace(/\s+(Online|Natural|Neural|Desktop|Mobile|Enhanced|Premium)\b.*/i, '')
    .replace(/\s+-\s+.*$/, '');
}

function updateVoiceDisplay() {
  const el = document.getElementById('stat-voice-name');
  if (!el) return;
  el.textContent = preferredVoice ? shortVoiceName(preferredVoice).substring(0, 14) : 'No voice';
}

// â”€â”€ Voice picker description helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function voiceDescription(v) {
  const name = v.name.toLowerCase();
  const lang = v.lang;

  // Google cloud voices
  if (name.includes('google')) {
    if (lang === 'zh-CN') return { desc: 'Google\'s cloud-based Mandarin voice. Clear, natural, and highly recommended. Requires an internet connection in Chrome.', badges: ['recommended', 'neural'] };
    if (lang === 'zh-TW') return { desc: 'Google\'s cloud-based Traditional Chinese (Taiwan) voice. Requires an internet connection in Chrome.', badges: ['neural'] };
    return { desc: 'Google cloud voice. Requires internet in Chrome.', badges: ['neural'] };
  }
  // macOS enhanced/premium
  if (name.includes('ting-ting') || name.includes('tingting')) return { desc: 'Apple\'s Ting-Ting â€” a high-quality Mandarin voice for macOS. Install the Enhanced version in System Settings for best clarity.', badges: ['system'] };
  if (name.includes('mei-jia') || name.includes('meijia')) return { desc: 'Apple\'s Mei-Jia â€” a warm Mandarin female voice for macOS. Available as Enhanced in System Settings.', badges: ['system'] };
  if (name.includes('sin-ji') || name.includes('sinji')) return { desc: 'Apple\'s Sin-Ji â€” a Cantonese voice for macOS.', badges: ['system'] };
  if (name.includes('lekiu')) return { desc: 'Apple\'s Lekiu â€” a Malay/Chinese voice for macOS.', badges: ['system'] };
  // Windows neural
  if (name.includes('xiaoxiao')) return { desc: 'Microsoft Xiaoxiao â€” a bright, expressive Mandarin neural voice. One of the best Windows options.', badges: ['neural'] };
  if (name.includes('yunxi'))    return { desc: 'Microsoft Yunxi â€” a warm male Mandarin neural voice for Windows.', badges: ['neural'] };
  if (name.includes('yunyang'))  return { desc: 'Microsoft Yunyang â€” a professional Mandarin male neural voice for Windows.', badges: ['neural'] };
  if (name.includes('xiaohan'))  return { desc: 'Microsoft Xiaohan â€” a gentle Mandarin female neural voice for Windows.', badges: ['neural'] };
  if (name.includes('xiaomeng')) return { desc: 'Microsoft Xiaomeng â€” a Mandarin female neural voice for Windows.', badges: ['neural'] };
  if (name.includes('xiaomo'))   return { desc: 'Microsoft Xiaomo â€” a calm Mandarin female neural voice for Windows.', badges: ['neural'] };
  if (name.includes('xiaorui'))  return { desc: 'Microsoft Xiaorui â€” a Mandarin female neural voice for Windows.', badges: ['neural'] };
  if (name.includes('xiaoshuang')) return { desc: 'Microsoft Xiaoshuang â€” a child-like Mandarin neural voice for Windows.', badges: ['neural'] };
  if (name.includes('xiaoyan'))  return { desc: 'Microsoft Xiaoyan â€” an older standard Mandarin voice for Windows.', badges: ['system'] };
  if (name.includes('xiaoyou'))  return { desc: 'Microsoft Xiaoyou â€” a youthful Mandarin neural voice for Windows.', badges: ['neural'] };
  if (name.includes('yunjian'))  return { desc: 'Microsoft Yunjian â€” a Mandarin male neural voice for Windows.', badges: ['neural'] };
  if (name.includes('yunfeng'))  return { desc: 'Microsoft Yunfeng â€” a Mandarin male neural voice for Windows.', badges: ['neural'] };
  if (name.includes('yunhao'))   return { desc: 'Microsoft Yunhao â€” a Mandarin male neural voice for Windows.', badges: ['neural'] };
  if (name.includes('yunxia'))   return { desc: 'Microsoft Yunxia â€” a Mandarin female neural voice for Windows.', badges: ['neural'] };
  if (name.includes('xiaozhen')) return { desc: 'Microsoft Xiaozhen â€” a Mandarin female neural voice for Windows.', badges: ['neural'] };
  if (name.includes('huihui'))   return { desc: 'Microsoft Huihui â€” an older standard Mandarin voice for Windows.', badges: ['system'] };
  if (name.includes('kangkang')) return { desc: 'Microsoft Kangkang â€” an older male Mandarin voice for Windows.', badges: ['system'] };
  if (name.includes('yaoyao'))   return { desc: 'Microsoft Yaoyao â€” an older child Mandarin voice for Windows.', badges: ['system'] };
  // Fallback
  const platform = v.localService ? 'On-device' : 'Cloud-based';
  const locale = lang === 'zh-CN' ? 'Mandarin (Simplified)' : lang === 'zh-TW' ? 'Mandarin (Traditional)' : lang;
  return { desc: `${platform} voice Â· ${locale}.`, badges: ['system'] };
}

// â”€â”€ Voice picker open / close / render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openVoicePicker() {
  renderVoicePicker();
  document.getElementById('voice-overlay').classList.add('open');
}

function closeVoicePicker(event) {
  if (event && event.target !== document.getElementById('voice-overlay')) return;
  synth.cancel();
  document.getElementById('voice-overlay').classList.remove('open');
}

function selectVoice(idx) {
  voiceIndex = idx;
  preferredVoice = allChineseVoices[idx];
  updateVoiceDisplay();
  renderVoicePicker();
}

function previewVoice(idx, btnEl) {
  synth.cancel();
  const v = allChineseVoices[idx];
  if (!v) return;
  // Toggle playing state on button
  document.querySelectorAll('.voice-preview-btn').forEach(b => b.classList.remove('playing'));
  btnEl.classList.add('playing');
  btnEl.textContent = 'â–¶ Playingâ€¦';
  const utter = new SpeechSynthesisUtterance('ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ä¸­æ–‡åŠ©æ‰‹ã€‚');
  utter.lang = 'zh-CN';
  utter.voice = v;
  utter.rate = 0.82;
  utter.pitch = 1.0;
  utter.onend = () => {
    btnEl.classList.remove('playing');
    btnEl.textContent = 'â–¶ Preview';
  };
  utter.onerror = () => {
    btnEl.classList.remove('playing');
    btnEl.textContent = 'â–¶ Preview';
  };
  synth.speak(utter);
}

function renderVoicePicker() {
  const list = document.getElementById('voice-list');
  if (!list) return;

  if (allChineseVoices.length === 0) {
    list.innerHTML = `<div class="voice-no-voices">
      No Chinese voices found on this device.<br><br>
      <strong>To add voices:</strong><br>
      <strong>macOS:</strong> System Settings â†’ Accessibility â†’ Spoken Content â†’ Manage Voices â†’ Chinese<br>
      <strong>Windows:</strong> Settings â†’ Time &amp; Language â†’ Language â†’ Add Chinese (Simplified)<br>
      <strong>Chrome:</strong> Google æ™®é€šè¯ appears automatically when online.
    </div>`;
    return;
  }

  list.innerHTML = allChineseVoices.map((v, idx) => {
    const isSelected = preferredVoice && v.name === preferredVoice.name && v.lang === preferredVoice.lang;
    const { desc, badges } = voiceDescription(v);
    const badgeHTML = badges.map(b => {
      if (b === 'recommended') return `<span class="voice-badge voice-badge-recommended">â˜… Recommended</span>`;
      if (b === 'neural')      return `<span class="voice-badge voice-badge-neural">Neural</span>`;
      return `<span class="voice-badge voice-badge-system">System</span>`;
    }).join(' ');
    const displayName = shortVoiceName(v);
    const langLabel = v.lang === 'zh-CN' ? 'Mandarin CN' : v.lang === 'zh-TW' ? 'Mandarin TW' : v.lang;
    return `<div class="voice-item${isSelected ? ' selected' : ''}" onclick="selectVoice(${idx})">
      <div class="voice-item-radio"></div>
      <div class="voice-item-info">
        <div class="voice-item-name">${displayName} <span style="font-weight:400;color:var(--muted);font-size:0.75rem;">${langLabel}</span> ${badgeHTML}</div>
        <div class="voice-item-desc">${desc}</div>
      </div>
      <div class="voice-item-actions">
        <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice(${idx}, this)">â–¶ Preview</button>
      </div>
    </div>`;
  }).join('');
}

if (synth.onvoiceschanged !== undefined) {
  synth.onvoiceschanged = loadVoices;
}
setTimeout(loadVoices, 100); // Immediate + delayed for async voice loading
loadVoices();

function speak(text, rate = 0.82, onEnd = null) {
  synth.cancel();
  // Small delay after cancel to avoid Chrome TTS bug
  setTimeout(() => {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'zh-CN';
    if (preferredVoice) utter.voice = preferredVoice;
    // Slightly slower rate for clarity â€” Beijing newsreader style
    utter.rate = rate;
    // Natural pitch â€” 1.0 is default, avoid artificial lowering which causes roboticness
    utter.pitch = 1.0;
    utter.volume = 1.0;
    if (onEnd) utter.onend = onEnd;
    utter.onerror = () => { if (onEnd) onEnd(); };
    synth.speak(utter);
  }, 50);
}

function stripEllipsis(text) {
  return text.replace(/\.{2,}|â€¦+|â€¦â€¦/g, '').trim();
}

function autoPlaySequence() {
  if (currentCardIdx >= queue.length) return;
  const item = queue[currentCardIdx];
  const { word } = item;
  // Strip trailing ellipsis from sentence starters before TTS
  const spokenWord = currentDeck === 'sentences' ? stripEllipsis(word.simp) : word.simp;

  setAudioBtnState('word-audio-btn', true);
  speak(spokenWord, 0.8, () => {
    setAudioBtnState('word-audio-btn', false);
    // Brief pause then sentence
    setTimeout(() => {
      setAudioBtnState('sent-audio-btn', true);
      speak(word.example_zh, 0.85, () => {
        setAudioBtnState('sent-audio-btn', false);
      });
    }, 800);
  });
}

function speakWord() {
  if (currentCardIdx >= queue.length) return;
  const item = queue[currentCardIdx];
  const spokenWord = currentDeck === 'sentences' ? stripEllipsis(item.word.simp) : item.word.simp;
  synth.cancel();
  setAudioBtnState('word-audio-btn', true);
  speak(spokenWord, 0.8, () => {
    setAudioBtnState('word-audio-btn', false);
  });
}

function speakSentence() {
  if (currentCardIdx >= queue.length) return;
  const item = queue[currentCardIdx];
  synth.cancel();
  setAudioBtnState('sent-audio-btn', true);
  speak(item.word.example_zh, 0.85, () => {
    setAudioBtnState('sent-audio-btn', false);
  });
}

function setAudioBtnState(id, playing) {
  const btn = document.getElementById(id);
  if (!btn) return;
  if (playing) {
    btn.classList.add('playing');
    btn.innerHTML = `<span class="wave-anim"><span class="wave-bar"></span><span class="wave-bar"></span><span class="wave-bar"></span><span class="wave-bar"></span></span> Playing...`;
  } else {
    btn.classList.remove('playing');
    const label = id === 'word-audio-btn' ? 'Speak word' : 'Speak sentence';
    btn.innerHTML = `<span class="speaker-icon">ðŸ”Š</span> ${label}`;
  }
}

// ============================================================
// RATING
// ============================================================
function rateCard(quality) {
  if (currentCardIdx >= queue.length) return;
  synth.cancel();

  const item = queue[currentCardIdx];
  const key = getCardKey(item.level, item.idx);

  const isNewCard = !item.srs.nextReview; // true if this is the card's very first review
  const newSRS = sm2({ srs: item.srs }, quality);
  state.cards[key] = { ...(state.cards[key] || {}), srs: newSRS, lastRating: quality };

  sessionReviewed++;

  // Record analytics history
  const todayKey = toDateKey(new Date());
  if (!state.history.dailyLog[todayKey]) state.history.dailyLog[todayKey] = { reviews: 0, newCards: 0 };
  state.history.dailyLog[todayKey].reviews++;
  if (isNewCard) state.history.dailyLog[todayKey].newCards++;
  const rKey = quality === 0 ? 'forgot' : quality === 2 ? 'hard' : quality === 3 ? 'good' : 'easy';
  state.history.ratingCounts[rKey] = (state.history.ratingCounts[rKey] || 0) + 1;

  // Update streak
  const today = new Date().toDateString();
  if (state.session.lastStudyDate !== today) {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    if (state.session.lastStudyDate === yesterday.toDateString()) {
      state.session.streak = (state.session.streak || 0) + 1;
    } else if (state.session.lastStudyDate !== today) {
      state.session.streak = 1;
    }
    state.session.lastStudyDate = today;
    if ((state.session.streak || 0) > (state.session.longestStreak || 0)) {
      state.session.longestStreak = state.session.streak;
    }
  }

  saveState();

  if (quality === 0) {
    // Forgot: reinsert at end of queue for retry this session
    queue.push({ ...item, srs: newSRS });
  } else if (quality === 2) {
    // Hard: reinsert a few cards ahead so it comes back soon but not immediately
    const insertAt = Math.min(currentCardIdx + 4, queue.length);
    queue.splice(insertAt, 0, { ...item, srs: newSRS });
  }

  currentCardIdx++;
  updateStats();

  // Animate transition
  const container = document.getElementById('card-container');
  container.style.opacity = '0';
  container.style.transform = 'translateX(-20px)';
  container.style.transition = 'all 0.2s ease';

  setTimeout(() => {
    container.style.opacity = '1';
    container.style.transform = 'translateX(0)';
    container.style.transition = 'all 0.3s ease';
    showCard();
  }, 200);
}

// ============================================================
// LEVEL SELECTION
// ============================================================
function setLevel(level) {
  currentLevel = level;
  document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  currentCardIdx = 0;
  sessionReviewed = 0;
  buildQueue();
  showCard();
  synth.cancel();
}

// ============================================================
// EMPTY STATE
// ============================================================
function showEmptyState() {
  const container = document.getElementById('card-container');
  container.innerHTML = `
    <div class="empty-state">
      <div class="empty-char">å¥½</div>
      <div class="empty-title">All done for today!</div>
      <div class="empty-sub">
        You've reviewed all ${sessionReviewed} cards. Come back tomorrow for your next review session.
        Your spaced repetition schedule has been updated.
      </div>
      <br>
      <button class="start-btn" onclick="resetSession()" style="font-size:0.9rem;padding:0.8rem 2rem;">
        Review Again
      </button>
    </div>
  `;
  document.getElementById('progress-fill').style.width = '100%';
}

function resetSession() {
  currentCardIdx = 0;
  sessionReviewed = 0;
  buildQueue();
  showCard();
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ============================================================
// ANALYTICS PANEL
// ============================================================

function toDateKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

let analyticsTab = 'daily';

function openAnalytics() {
  renderAnalyticsPanel();
  document.getElementById('analytics-overlay').classList.add('open');
  document.getElementById('analytics-panel').classList.add('open');
}

function closeAnalytics() {
  document.getElementById('analytics-overlay').classList.remove('open');
  document.getElementById('analytics-panel').classList.remove('open');
}

function setAnalyticsTab(tab) {
  analyticsTab = tab;
  document.querySelectorAll('.act-tab').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });
  document.getElementById('act-chart-area').innerHTML = buildActivityRows();
}

function renderAnalyticsPanel() {
  document.getElementById('analytics-body').innerHTML =
    buildSummaryHTML() + buildRatingHTML() + buildActivitySectionHTML();
}

function buildSummaryHTML() {
  let learnedCount = 0;
  for (const key in state.cards) {
    if (state.cards[key].srs && state.cards[key].srs.nextReview) learnedCount++;
  }
  const rc = state.history.ratingCounts;
  const totalRatings = (rc.forgot||0) + (rc.hard||0) + (rc.good||0) + (rc.easy||0);
  const longestStreak = Math.max(state.session.longestStreak || 0, state.session.streak || 0);
  // Calculate total new cards learned (sum of all dailyLog newCards)
  let totalNew = 0;
  for (const day in state.history.dailyLog) totalNew += (state.history.dailyLog[day].newCards || 0);
  return `
    <div class="an-summary">
      <div class="an-summary-item">
        <span class="an-summary-num">${learnedCount}</span>
        <span class="an-summary-label">Cards Learned</span>
      </div>
      <div class="an-summary-item">
        <span class="an-summary-num">${totalRatings.toLocaleString()}</span>
        <span class="an-summary-label">Total Reviews</span>
      </div>
      <div class="an-summary-item">
        <span class="an-summary-num">${state.session.streak || 0}</span>
        <span class="an-summary-label">Current Streak</span>
      </div>
      <div class="an-summary-item">
        <span class="an-summary-num">${longestStreak}</span>
        <span class="an-summary-label">Best Streak</span>
      </div>
    </div>`;
}

function buildRatingHTML() {
  // --- Snapshot: last rating per learned card ---
  const snap = {0:0, 2:0, 3:0, 5:0};
  let learnedTotal = 0;
  for (const key in state.cards) {
    const card = state.cards[key];
    if (card.srs && card.srs.nextReview) {
      learnedTotal++;
      const lr = card.lastRating !== undefined ? card.lastRating : 3;
      snap[lr] = (snap[lr] || 0) + 1;
    }
  }
  const snapW   = (n) => learnedTotal > 0 ? ((n / learnedTotal * 100).toFixed(1) + '%') : '0%';
  const snapPct = (n) => learnedTotal > 0 ? (n / learnedTotal * 100).toFixed(1) : '0.0';

  const snapshotHTML = learnedTotal > 0 ? `
    <div class="snap-bar">
      <div class="snap-seg s0" style="width:${snapW(snap[0])}"></div>
      <div class="snap-seg s2" style="width:${snapW(snap[2])}"></div>
      <div class="snap-seg s3" style="width:${snapW(snap[3])}"></div>
      <div class="snap-seg s5" style="width:${snapW(snap[5])}"></div>
    </div>
    <div class="an-legend">
      <span class="an-legend-item"><span class="an-legend-dot s0"></span>âœ— Forgot &nbsp;${snapPct(snap[0])}%&nbsp;(${snap[0]})</span>
      <span class="an-legend-item"><span class="an-legend-dot s2"></span>â—‘ Hard &nbsp;${snapPct(snap[2])}%&nbsp;(${snap[2]})</span>
      <span class="an-legend-item"><span class="an-legend-dot s3"></span>âœ“ Good &nbsp;${snapPct(snap[3])}%&nbsp;(${snap[3]})</span>
      <span class="an-legend-item"><span class="an-legend-dot s5"></span>â˜… Easy &nbsp;${snapPct(snap[5])}%&nbsp;(${snap[5]})</span>
    </div>` : `<div class="act-empty">No cards learned yet â€” start reviewing to see this data.</div>`;

  // --- All-time rating counts ---
  const rc = state.history.ratingCounts;
  const totalRatings = (rc.forgot||0) + (rc.hard||0) + (rc.good||0) + (rc.easy||0);
  const maxCount = Math.max(rc.forgot||0, rc.hard||0, rc.good||0, rc.easy||0, 1);
  const bw = (n) => ((n / maxCount) * 100).toFixed(1) + '%';

  const allTimeHTML = totalRatings > 0 ? `
    <div class="rbar-row">
      <span class="rbar-label" style="color:var(--red)">âœ— Forgot</span>
      <div class="rbar-track"><div class="rbar-fill s0" style="width:${bw(rc.forgot||0)}"></div></div>
      <span class="rbar-count">${(rc.forgot||0).toLocaleString()}</span>
    </div>
    <div class="rbar-row">
      <span class="rbar-label" style="color:#d35400">â—‘ Hard</span>
      <div class="rbar-track"><div class="rbar-fill s2" style="width:${bw(rc.hard||0)}"></div></div>
      <span class="rbar-count">${(rc.hard||0).toLocaleString()}</span>
    </div>
    <div class="rbar-row">
      <span class="rbar-label" style="color:var(--blue)">âœ“ Good</span>
      <div class="rbar-track"><div class="rbar-fill s3" style="width:${bw(rc.good||0)}"></div></div>
      <span class="rbar-count">${(rc.good||0).toLocaleString()}</span>
    </div>
    <div class="rbar-row">
      <span class="rbar-label" style="color:var(--green)">â˜… Easy</span>
      <div class="rbar-track"><div class="rbar-fill s5" style="width:${bw(rc.easy||0)}"></div></div>
      <span class="rbar-count">${(rc.easy||0).toLocaleString()}</span>
    </div>
    <div style="font-size:0.72rem;color:var(--muted);margin-top:0.3rem;">${totalRatings.toLocaleString()} ratings recorded in total</div>
  ` : `<div class="act-empty">No ratings recorded yet â€” they will appear here as you study.</div>`;

  return `
    <div class="an-section">
      <div class="an-section-title">Rating Distribution</div>
      <div class="an-sub-label">Knowledge snapshot Â· last rating per learned card (${learnedTotal} cards)</div>
      ${snapshotHTML}
      <div class="an-sub-label" style="margin-top:1.1rem;">All-time rating totals</div>
      ${allTimeHTML}
    </div>`;
}

function buildActivitySectionHTML() {
  return `
    <div class="an-section">
      <div class="an-section-title">Activity Over Time</div>
      <div class="act-tabs">
        <button class="act-tab ${analyticsTab==='daily'?'active':''}" data-tab="daily" onclick="setAnalyticsTab('daily')">Daily Â· 7 days</button>
        <button class="act-tab ${analyticsTab==='weekly'?'active':''}" data-tab="weekly" onclick="setAnalyticsTab('weekly')">Weekly Â· 8 wks</button>
        <button class="act-tab ${analyticsTab==='monthly'?'active':''}" data-tab="monthly" onclick="setAnalyticsTab('monthly')">Monthly Â· 6 mo</button>
      </div>
      <div id="act-chart-area">${buildActivityRows()}</div>
      <div class="act-legend">
        <span class="an-legend-item"><span class="an-legend-dot" style="background:var(--blue);border-radius:2px;width:12px;height:9px;"></span>Reviews</span>
        <span class="an-legend-item"><span class="an-legend-dot" style="background:var(--red);border-radius:2px;width:12px;height:9px;"></span>New cards</span>
      </div>
    </div>`;
}

function getActivityPeriods() {
  const log = state.history.dailyLog;
  const now = new Date();
  const periods = [];
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const DAYS   = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  if (analyticsTab === 'daily') {
    for (let i = 6; i >= 0; i--) {
      const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
      const key = toDateKey(d);
      const data = log[key] || { reviews: 0, newCards: 0 };
      periods.push({ label: i === 0 ? 'Today' : DAYS[d.getDay()], reviews: data.reviews, newCards: data.newCards });
    }
  } else if (analyticsTab === 'weekly') {
    const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const daysSinceSunday = startOfToday.getDay();
    for (let i = 7; i >= 0; i--) {
      const weekStart = new Date(startOfToday);
      weekStart.setDate(startOfToday.getDate() - daysSinceSunday - i * 7);
      let reviews = 0, newCards = 0;
      for (let d = 0; d < 7; d++) {
        const day = new Date(weekStart);
        day.setDate(weekStart.getDate() + d);
        const data = log[toDateKey(day)] || { reviews: 0, newCards: 0 };
        reviews += data.reviews; newCards += data.newCards;
      }
      const label = i === 0 ? 'This wk' : `${MONTHS[weekStart.getMonth()]} ${weekStart.getDate()}`;
      periods.push({ label, reviews, newCards });
    }
  } else { // monthly
    for (let i = 5; i >= 0; i--) {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const year = d.getFullYear(), month = d.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let reviews = 0, newCards = 0;
      for (let day = 1; day <= daysInMonth; day++) {
        const key = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const data = log[key] || { reviews: 0, newCards: 0 };
        reviews += data.reviews; newCards += data.newCards;
      }
      periods.push({ label: i === 0 ? 'This mo' : MONTHS[month], reviews, newCards });
    }
  }
  return periods;
}

function buildActivityRows() {
  const periods = getActivityPeriods();
  const hasData = periods.some(p => p.reviews > 0);
  if (!hasData) return `<div class="act-empty">No activity recorded in this period yet.</div>`;

  const maxReviews = Math.max(...periods.map(p => p.reviews), 1);
  return periods.map(p => {
    const revOnlyPct = ((Math.max(0, p.reviews - p.newCards) / maxReviews) * 100).toFixed(1);
    const newPct     = ((p.newCards / maxReviews) * 100).toFixed(1);
    const countStr   = p.reviews > 0
      ? `${p.reviews}${p.newCards > 0 ? ` Â· <span style="color:var(--red)">${p.newCards} new</span>` : ''}`
      : '<span style="opacity:0.4">â€”</span>';
    return `
      <div class="act-row">
        <span class="act-row-label">${p.label}</span>
        <div class="act-row-track">
          <div class="act-bar-rev" style="width:${revOnlyPct}%"></div>
          <div class="act-bar-new" style="width:${newPct}%"></div>
        </div>
        <span class="act-row-count">${countStr}</span>
      </div>`;
  }).join('');
}

// ============================================================
// HSK ALL LEVELS CONFIG
// ============================================================
const HSK_ALL_LEVELS_KEY = 'hsk_all_levels';
let selectedHSKLevels = JSON.parse(localStorage.getItem(HSK_ALL_LEVELS_KEY) || '[1,2,3,4,5,6]');
let hskConfigSource = 'intro'; // 'intro' | 'session'

const HSK_LEVEL_INFO = {
  1: { name: 'HSK 1', sub: 'Beginner',          count: 154  },
  2: { name: 'HSK 2', sub: 'Elementary',         count: 151  },
  3: { name: 'HSK 3', sub: 'Pre-Intermediate',   count: 327  },
  4: { name: 'HSK 4', sub: 'Intermediate',       count: 615  },
  5: { name: 'HSK 5', sub: 'Upper-Intermediate', count: 1316 },
  6: { name: 'HSK 6', sub: 'Advanced',           count: 104  },
};

function openHSKConfig(source) {
  hskConfigSource = source || 'intro';
  updateHSKConfigUI();
  updateHSKConfigStats();
  document.getElementById('hsk-config-overlay').classList.add('open');
}

function closeHSKConfig() {
  document.getElementById('hsk-config-overlay').classList.remove('open');
}

function toggleHSKLevel(level) {
  const idx = selectedHSKLevels.indexOf(level);
  if (idx > -1) {
    if (selectedHSKLevels.length === 1) return; // keep at least one
    selectedHSKLevels.splice(idx, 1);
  } else {
    selectedHSKLevels.push(level);
    selectedHSKLevels.sort((a, b) => a - b);
  }
  // Save immediately so selection persists even if user just closes
  localStorage.setItem(HSK_ALL_LEVELS_KEY, JSON.stringify(selectedHSKLevels));
  updateHSKConfigUI();
  updateHSKConfigStats();
}

function updateHSKConfigUI() {
  for (let level = 1; level <= 6; level++) {
    const btn = document.querySelector(`.level-toggle-btn[data-level="${level}"]`);
    if (!btn) continue;
    const isActive = selectedHSKLevels.includes(level);
    btn.classList.toggle('active', isActive);
    // Mark last remaining active as disabled so it can't be deselected
    btn.classList.toggle('disabled-toggle', isActive && selectedHSKLevels.length === 1);
  }
}

function updateHSKConfigStats() {
  const maxNew = (state && state.settings && state.settings.newCardsPerDay) ? state.settings.newCardsPerDay : 20;
  let totalWords = 0, dueCount = 0, newCount = 0;
  for (const level of selectedHSKLevels) {
    const words = DECK_CACHE.hsk[level] || [];
    totalWords += words.length;
    words.forEach((word, idx) => {
      const srs = getCardSRS(level, idx);
      if (!srs.nextReview) newCount++;
      else if (isDue(srs)) dueCount++;
    });
  }
  const cappedNew = Math.min(newCount, maxNew);
  document.getElementById('hsk-stat-words').textContent = totalWords.toLocaleString();
  document.getElementById('hsk-stat-due').textContent   = dueCount;
  document.getElementById('hsk-stat-new').textContent   = cappedNew;
  const total = dueCount + cappedNew;
  const btn = document.getElementById('hsk-start-btn');
  btn.textContent = total > 0 ? `Start â€” ${total} cards` : 'Start Session';
  btn.disabled = selectedHSKLevels.length === 0;
}

function startHSKAll() {
  localStorage.setItem(HSK_ALL_LEVELS_KEY, JSON.stringify(selectedHSKLevels));
  document.getElementById('hsk-config-overlay').classList.remove('open');
  document.getElementById('deck-overlay').classList.remove('open');

  if (hskConfigSource === 'intro') {
    // Transition from intro screen to session
    currentDeck = 'hsk';
    const intro = document.getElementById('intro-screen');
    intro.style.transition = 'opacity 0.5s ease';
    intro.style.opacity = '0';
    setTimeout(() => { intro.style.display = 'none'; }, 500);
    const levelBar = document.getElementById('level-bar');
    if (levelBar) levelBar.style.display = 'none';
    setTimeout(() => { loadVoices(); }, 300);
    setTimeout(() => { loadVoices(); }, 1000);
    activeDeck = 'hsk';
    currentCardIdx = 0;
    sessionReviewed = 0;
    buildQueue();
    showCard();
  } else {
    // Mid-session: force fresh queue immediately
    currentDeck = 'hsk';
    activeDeck = 'hsk';
    currentCardIdx = 0;
    sessionReviewed = 0;
    synth.cancel();
    buildQueue();
    showCard();
    showToast('Switched to HSK All Levels');
  }
}

// ============================================================
// DECK SELECTION
// ============================================================
function introDeckSelect(deck) {
  if (COMING_SOON_DECKS.has(deck)) { showToast('Coming soon â€” check back shortly!'); return; }
  if (!isUnlocked(deck)) { openUpgradeModal(deck); return; }
  if (deck === 'hsk') {
    openHSKConfig('intro');
    return;
  }
  currentDeck = deck;
  document.querySelectorAll('[id^="deck-card-"]').forEach(el => {
    el.classList.toggle('selected', el.id === 'deck-card-' + deck);
  });
}

function openDeckOverlay() {
  document.querySelectorAll('[id^="modal-deck-"]').forEach(el => {
    el.classList.toggle('selected', el.id === 'modal-deck-' + currentDeck);
  });
  document.getElementById('deck-overlay').classList.add('open');
}

function closeDeckOverlay(event) {
  if (event && event.target !== document.getElementById('deck-overlay')) return;
  document.getElementById('deck-overlay').classList.remove('open');
}

function switchDeck(deck) {
  if (COMING_SOON_DECKS.has(deck)) { document.getElementById('deck-overlay').classList.remove('open'); showToast('Coming soon â€” check back shortly!'); return; }
  if (!isUnlocked(deck)) { document.getElementById('deck-overlay').classList.remove('open'); openUpgradeModal(deck); return; }
  if (deck === 'hsk') {
    document.getElementById('deck-overlay').classList.remove('open');
    openHSKConfig('session');
    return;
  }
  if (deck === currentDeck) {
    document.getElementById('deck-overlay').classList.remove('open');
    return;
  }
  currentDeck = deck;
  document.getElementById('deck-overlay').classList.remove('open');

  // Each deck is a specific level â€” hide level bar
  const levelBar = document.getElementById('level-bar');
  if (levelBar) levelBar.style.display = 'none';

  // Reset session for new deck
  activeDeck = deck;
  currentCardIdx = 0;
  sessionReviewed = 0;
  synth.cancel();
  buildQueue();
  showCard();

  const deckNames = { hsk:'HSK All Levels', hsk1:'HSK 1', hsk2:'HSK 2', hsk3:'HSK 3', hsk4:'HSK 4', hsk5:'HSK 5', hsk6:'HSK 6', sentences:'Sentence Starters' };
  showToast('Switched to ' + (deckNames[deck] || deck));
}

// ============================================================
// TEXT SIZE
// ============================================================
const TEXT_SIZES = {
  s:  '13px',
  m:  '16px',
  l:  '19px',
  xl: '22px',
};
const TEXT_SIZE_KEY = 'hsk_textsize';

function setTextSize(size) {
  if (!TEXT_SIZES[size]) return;
  document.documentElement.style.fontSize = TEXT_SIZES[size];
  localStorage.setItem(TEXT_SIZE_KEY, size);
  // Update active button
  document.querySelectorAll('.size-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.size === size);
  });
}

function loadTextSize() {
  const saved = localStorage.getItem(TEXT_SIZE_KEY) || 'm';
  setTextSize(saved);
}

// ============================================================
// HOME NAVIGATION
// ============================================================
let activeDeck = null; // the deck that was last built into the queue

function goHome() {
  synth.cancel();
  const intro = document.getElementById('intro-screen');
  intro.style.display = 'flex';
  intro.style.opacity = '0';
  // Tiny delay so display:flex takes effect before the transition fires
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      intro.style.transition = 'opacity 0.4s ease';
      intro.style.opacity = '1';
    });
  });
  // Reflect current deck selection in the intro screen cards
  document.querySelectorAll('[id^="deck-card-"]').forEach(el => {
    el.classList.toggle('selected', el.id === 'deck-card-' + currentDeck);
  });
}

// ============================================================
// START
// ============================================================
function startApp() {
  const intro = document.getElementById('intro-screen');
  intro.style.transition = 'opacity 0.5s ease';
  intro.style.opacity = '0';
  setTimeout(() => { intro.style.display = 'none'; }, 500);

  // Level bar not needed with per-level decks
  const levelBar = document.getElementById('level-bar');
  if (levelBar) levelBar.style.display = 'none';

  // Try voice loading again (browsers sometimes delay voice list availability)
  setTimeout(() => { loadVoices(); }, 300);
  setTimeout(() => { loadVoices(); }, 1000);

  // If the deck hasn't changed and a session is already in progress, resume it
  if (activeDeck === currentDeck && queue.length > 0) {
    showCard();
    return;
  }

  // Otherwise start fresh for the chosen deck
  activeDeck = currentDeck;
  currentCardIdx = 0;
  sessionReviewed = 0;
  buildQueue();
  showCard();
}

// Init â€” load deck JSON files then start
loadTextSize();
loadState();
updateAuthHeaderButton(); // show/hide auth row immediately (Supabase loads async below)
applyLockStateToDeckCards(); // apply lock state with no entitlements (guest view)
handlePaymentReturn();       // check for ?payment=success in URL after Stripe redirect
loadAllDecks().then(() => {
  buildQueue();
}).catch(err => {
  console.error('Failed to load deck data:', err);
  document.body.innerHTML = '<div style="padding:2rem;text-align:center;font-family:sans-serif"><h2>Failed to load deck data</h2><p>Please refresh the page.</p></div>';
});
</script>

<!-- â”€â”€ Supabase JS (Auth + Database) â€” loaded async, never blocks page â”€â”€ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"
        onload="initSupabase()"
        onerror="console.warn('Supabase CDN failed to load â€” auth disabled')"></script>

<!-- â”€â”€ Service Worker Registration (PWA / offline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.warn('SW registration failed:', err));
    });
  }
</script>
</body>
</html>
